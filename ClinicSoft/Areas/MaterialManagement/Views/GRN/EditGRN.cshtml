@model BusinessEntities.Accounts.MaterialManagement.GRN_and_Items
<div class="modal-header py-3 px-4">
    <h5 class="modal-title text-primary font-weight-semibold" id="exampleModalLongTitle">Update GRN</h5>
    <button aria-label="Close" data-bs-dismiss="modal" class="btn-close" type="button"><span aria-hidden="true">×</span></button>
</div>
<div class="modal-body p-4">
    <div class="row">
        <div class="col-sm-12 col-md-12 col-lg-12 mb-4 font-weight-semibold">
            <span class="text-danger" style="font-size:smaller">Required fields are marked with *</span>
        </div>
    </div>
    <form id="form_EditGRN" >
        @Html.AntiForgeryToken()
        <div class="row">
            <div class="col-sm-12 col-md-6 col-lg-3">
                <div class="form-group">
                    <label class="form-label text-black">Branch&nbsp;<span class="text-danger">*</span></label>
                    <span class="text-dark"> @Html.DisplayFor(m => m.grn.branch_name)</span>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-2">
                <div class="form-group">
                    <label class="form-label text-black">
                        Purchase Order&nbsp;
                        <span class="text-danger">*&nbsp;<label id="lbl_message" class="fw-bold"></label></span>
                    </label>
                    <span class="text-dark">@Html.DisplayFor(m => m.grn.purchase_order)</span>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-2">
                <div class="form-group">
                    <label class="form-label text-black">GRN Date&nbsp;<span class="text-danger">*</span></label>
                    @Html.TextBox("u_pr_date", Model.grn.pr_date, new { @class = "form-control", @placeholder = "DD-MMMM-YYYY", maxlength = "18" })
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-2" id="div_sup_invoice">
                <div class="form-group">
                    <label class="form-label text-black">Supplier GRN&nbsp;<span class="text-danger">*</span></label>
                    @Html.TextBox("u_pr_supplier_inv", Model.grn.pr_supplier_inv, new { @class = "form-control", maxlength = "15", @placeholder = "Enter Supplier Invoice No." })
                </div>
            </div>
            <div class="col-sm-12 col-md-6 col-lg-2">
                <div class="form-group">
                    <label class="form-label text-black">Supplier GRN Date&nbsp;<span class="text-danger">*</span></label>
                    @Html.TextBox("u_pr_supplier_inv_date", Model.grn.pr_supplier_inv_date, new { @class = "form-control", @placeholder = "DD-MMMM-YYYY", maxlength = "18" })
                </div>
            </div>

            <div class="col-sm-12 col-md-6 col-lg-3">
                <div class="form-group">
                    <label class="form-label text-black">Notes</label>
                    @Html.TextArea("u_pr_notes", Model.grn.pr_notes, new { @class = "form-control", maxlength = "998", @placeholder = "Enter Notes", @rows = "3" })
                </div>
            </div>
        </div>

        <div id="divGRN_items">
            <div class="col-sm-12 col-md-12 col-lg-12">
                <div class="row mt-2">
                    <div class="col-md-12">
                        <small>
                            <span class="text-info">
                                Item - <span class="text-lime fw-bold">Receving Item Code and Name</span>  |
                                O.Qty - <span class="text-lime fw-bold">Ordered Qty-UOM</span> |
                                OF.Qty - <span class="text-lime fw-bold">Ordred Free Qty-UOM</span> |
                                B.Qty - <span class="text-lime fw-bold">Balance Qty-UOM</span> |
                                E.Date - <span class="text-lime fw-bold">Batch Expiry Date</span> |
                                U.Price - <span class="text-lime fw-bold">Unit Price</span> |
                                R.Qty - <span class="text-lime fw-bold">Received Qty</span> |
                                F.Batch - <span class="text-lime fw-bold">Free Qty Batch Batch</span> |
                                FE.Date - <span class="text-lime fw-bold">Free Batch Expiry Date</span>
                            </span>
                        </small>
                    </div>
                </div>
                <div class="table-responsive mt-2">
                    <table id="tbl_grn_edit" class="table table-striped table-bordered text-nowrap resize-table" style="width: 100%; cursor: pointer;">
                        <thead>
                            <tr style="color: #fff !important; background-color: #3C457D; border-color: #3C457D; ">
                                <th class="border-bottom-0 font-weight-semibold text-white text-center">PIR_ID</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">Item</th>
                                <th class="border-bottom-0 font-weight-semibold text-white text-center">O.Qty</th>
                                <th class="border-bottom-0 font-weight-semibold text-white text-center">OF.Qty</th>
                                <th class="border-bottom-0 font-weight-semibold text-white text-center">B.Qty</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">Batch <span class="text-danger">*</span></th>
                                <th class="border-bottom-0 font-weight-semibold text-white">E.Date <span class="text-danger">*</span></th>
                                <th class="border-bottom-0 font-weight-semibold text-white text-center">U.Price<span class="text-danger">*</span></th>
                                <th class="border-bottom-0 font-weight-semibold text-white">R.Qty <span class="text-danger">*</span></th>
                                <th class="border-bottom-0 font-weight-semibold text-white">UOM <span class="text-danger">*</span></th>
                                <th class="border-bottom-0 font-weight-semibold text-white">Free Qty</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">UOM (Free)</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">F.Batch</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">FE.Date</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">Edit</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">ItemID</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">pi_bqty</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">pi_bqty2</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">pi_bqty3</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">pi_bqty_uom</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">pi_bqty2_uom</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">pi_bqty3_uom</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">PiId</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">pir_uom</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">pir_freeuom</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">pir_received</th>
                                <th class="border-bottom-0 font-weight-semibold text-white">pir_free_qty</th>
                            </tr>
                        </thead>
                        <tfoot class="d-none">
                            <tr>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th class="table_footer_align"><span class="text-right text-dark"> Total Qty: &nbsp;</span></th>
                                <th class="table_footer_align"><span id="r_total_qty"></span></th>
                                <th></th>
                                <th class="table_footer_align"><span id="f_total_qty"></span></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="row mt-2">
                <div id="error" class="text-center"></div>
                <div class="col-sm-12 col-md-12 col-lg-12 text-center">
                    <button type="submit" class="btn btn-outline-warning" id="btn_Update"><i class="fe fe-check-circle"></i> Save Changes</button>
                    <button type="button" class="btn btn-cyan" id="btn_PrintBarcode"><i class="fa fa-barcode"></i> Print Barcodes</button>
                    <button type="button" class="btn btn-outline-primary" id="btnPrintGRN_edit"><i class="fe fe-printer"></i> Print GRN</button>
                    <button type="button" class="btn btn-outline-danger me-1" data-bs-dismiss="modal">
                        Close
                    </button>
                    <label class="text-red" id="edit_error_message"></label>
                    <input type="hidden" id="u_hi_prId" value="0" />
                    <input type="hidden" id="u_hi_pr_orderCode" value="" />
                    <input type="hidden" id="u_hi_pr_orderId" value="" />
                    <input type="hidden" id="u_hi_pr_supplier" value="" />
                    <input type="hidden" id="u_hi_pr_code" value="" />
                    <input type="hidden" id="u_hi_pr_branch" value="" />
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-12 col-md-12 d-flex justify-content-center text-center">
            <div id="edit_grn_error" class="text-center" style="max-width:500px"></div>
        </div>
        <div class="col-12 col-sm-12 col-md-12 d-flex justify-content-center text-center">
            <div id="Edit_GRN_Alert"></div>
        </div>
        @if (TempData["ErrorMessage_Update"] != null)
        {
            <div class="col-12 col-sm-12 col-md-12 d-flex justify-content-center text-center">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    <strong>Error!&nbsp;</strong>@TempData["ErrorMessage_Update"]
                </div>
            </div>
        }
    </form>
</div>
<script>
    var grn_item_arr = [];

    //#region Page Load
    $(function () {
        $('#u_pr_date').bootstrapdatepicker({
            format: "dd-MM-yyyy",
            viewMode: "date",
            todayHighlight: true,
            autoclose: true,
            multidate: false,
            multidateSeparator: "-",
            startDate:new Date('@Model.grn.purchase_orderDate')
        });
        $('#u_pr_supplier_inv_date').bootstrapdatepicker({
            format: "dd-MM-yyyy",
            viewMode: "date",
            todayHighlight: true,
            autoclose: true,
            multidate: false,
            multidateSeparator: "-",
            startDate:new Date('@Model.grn.purchase_orderDate')
        });
        $("#u_pr_date").val(moment('@Model.grn.pr_date', 'DD/MM/YYYY').format('DD-MMMM-YYYY')).trigger("change");
        $("#u_pr_supplier_inv_date").val(moment('@Model.grn.pr_supplier_inv_date', 'DD/MM/YYYY').format('DD-MMMM-YYYY')).trigger("change");
        validation();
        $("#btn_Update").show();
        $("#btn_PrintBarcode").hide();
        $("#btnPrintGRN_edit").hide();

        grn_item_arr = @Html.Raw(Json.Encode(Model.grn_items));
        $('#u_hi_pr_branch').val('@Model.grn.pr_branch');
        $('#u_hi_prId').val('@Model.grn.prId');
        $('#u_hi_pr_orderCode').val('@Model.grn.purchase_order');
        $('#u_hi_pr_orderId').val('@Model.grn.pr_PurchaseOrder');
        $('#u_hi_pr_code').val('@Model.grn.pr_code');
        BindDataTable(grn_item_arr);
    });
    //#endregion

    //#region Branch Select Event
    $('#pr_branch').on('select2:select', function (e) {
        if ($('#pr_branch').val() != null && $('#pr_branch').val() != "" && $('#pr_branch').val() != undefined) {
            $('#lbl_message').text('');
        }
    });
    //#endregion

    //#region Adding Validation on Main Form
    var validation = function () {
        $("#form_EditGRN").validate({
            focusInvalid: true,
            rules:
            {
                u_pr_date: {
                    required: true,
                },
                u_pr_supplier_inv: {
                    required: true,
                },
                u_pr_supplier_inv_date: {
                    required: true,
                },
            },
            messages: {
                u_pr_date: {
                    required: "Select GRN Date",
                },
                u_pr_supplier_inv: {
                    required: "Enter Supplier GRN No#",
                },
                u_pr_supplier_inv_date: {
                    required: "Select Supplier GRN Date",
                },
            },
            highlight: function (element) {
                var elem = $(element);
                if (elem.hasClass("select2-hidden-accessible")) {
                    $("#select2-" + elem.attr("id") + "-container").parent().addClass('error');
                } else {
                    elem.parent().addClass('has-error');
                }
                $(element).parent().addClass('has-error');
                Error_Timeout(elem.attr("id"));
            },
            unhighlight: function (element) {
                var elem = $(element);
                if (elem.hasClass("select2-hidden-accessible")) {
                    $("#select2-" + elem.attr("id") + "-container").parent().removeClass('error');
                } else {
                    elem.removeClass('has-error');
                }
                $(element).parent().removeClass('has-error');
            },
            errorElement: 'span',
            errorClass: 'text-danger fw-bold',
            errorPlacement: function (error, element) {
                var elem = $(element);
                if (elem.hasClass("select2-hidden-accessible")) {
                    element = $("#select2-" + elem.attr("id") + "-container").parent();
                    error.insertAfter(element);
                } else {
                    error.insertAfter(element);
                }
                if (element.parent('.input-group').length) {
                    error.insertAfter(element.parent());
                } else {
                    error.insertAfter(element);
                }
            }
        });
    }
    $('#u_pr_date').keypress(function (e) {
        var charCode = (e.which) ? e.which : event.keyCode
        if (String.fromCharCode(charCode).match(/[^0-9./-]/g)) {
            return false;

        }
        else {
            if (e.target.value.length >= 18)
                return false;
        }
    });
    $('#u_pr_supplier_inv_date').keypress(function (e) {
        var charCode = (e.which) ? e.which : event.keyCode
        if (String.fromCharCode(charCode).match(/[^0-9./-]/g)) {
            return false;

        }
        else {
            if (e.target.value.length >= 18)
                return false;
        }
    });
    //#endregion

    //#region Bind Datatable
    var BindDataTable = function (response) {
        var table = $("#tbl_grn_edit").DataTable({
            fixedHeader: {
                header: true,
                footer: true
            },
            processing: true,
            searching: false,
            "deferRender": true,
            "pageLength": 100,
            "retrieve": true,
            lengthChange: true,
            scrollX: true,
            scrollY: 500,
            scrollCollapse: true,
            "aaData": response,
            "aoColumns": [
                {
                    "mData": "pirId",
                },
                {
                    "mData": "item_code",
                    "className": "td_max_width",
                    "render": function (item_code, type, full, meta) {
                        var item_code = '<span class="text-info">' + full.item_code + '</span><br>' + full.item_name;
                        return item_code;
                    }
                },
                {
                    "mData": "pi_oqty",
                    "className": "text-center",
                    "render": function (pi_oqty, type, full, meta) {
                        var qty_uom = full.pi_oqty + " - " + full.pi_uom;
                        return qty_uom;
                    }
                },
                {
                    "mData": "pi_freeQty",
                    "className": "text-center",
                    "render": function (pi_freeQty, type, full, meta) {
                        var fqty_uom = full.pi_freeQty + " - " + full.pi_freeUOM
                        return fqty_uom;
                    }
                },
                {
                    "mData": "pi_bqty",
                    "className": "text-center",
                    "render": function (pi_bqty, type, full, meta) {
                        var bqty_uom = full.pi_bqty + " - " + full.pi_bqty_uom
                        return bqty_uom;
                    }
                },
                {
                    "mData": "pirId",
                    "orderable": false,
                    "searchable": false,
                    "render": function (pirId, type, full, meta) {
                        var html_links = '<input type="text" class="form-control pi_batch" disabled id="pi_batch_' + full.pirId + '" placeholder="Enter Batch" maxlength = "45" value="' + full.pir_batchno + '"/>';
                        return html_links;
                    }
                },
                {
                    "mData": "pi_edate",
                    "orderable": false,
                    "searchable": false,
                    "render": function (pirId, type, full, meta) {
                        var html_links = '<input type="text" class="form-control pi_expiry" disabled id="pi_edate_' + full.pirId + '" placeholder=""DD-MMMM-YYYY" maxlength = "18" value=' + full.pir_edate + ' style="max-width:140px !important; min-width:100px !important;" />';
                        return html_links;
                    }
                },
                {
                    "mData": "pi_uprice",
                    "className": "text-end",
                    "render": function (pirId, type, full, meta) {
                        var html_links = '<input type="text" class="form-control text-end pi_uprice " disabled id="pi_uprice_' + full.pirId + '" maxlength = "15" onkeypress="return validateOneDecimalNumeric(this,event);" value="' + full.pir_uprice + '" style="max-width:80px !important; min-width:70px !important;" onfocusout="checkQtyValidation(event, \'' + full.pi_bqty + '\',\'' + full.pi_oqty + '\',\'' + full.pirId + '\',\'' + full.pir_received + '\')"/>';
                        return html_links;
                    }
                },
                {
                    "mData": "pi_rqty",
                    "orderable": false,
                    "searchable": false,
                    "render": function (pirId, type, full, meta) {
                        var html_links = '<input type="text" class="form-control text-end pi_receivedqty " disabled id="pi_receivedqty_' + full.pirId + '" maxlength = "15" onkeypress="return validateOneDecimalNumeric(this,event);" value="' + full.pir_received + '" style="max-width:80px !important; min-width:70px !important;" onfocusout="checkQtyValidation(event, \'' + full.pi_bqty + '\',\'' + full.pi_oqty + '\',\'' + full.pirId + '\',\'' + full.pir_received + '\')"/>';
                        return html_links;
                    }
                },
                {
                    "mData": "pi_uom",
                    "orderable": false,
                    "searchable": false,
                    "render": function (pirId, type, full, meta) {
                        var html_links = '<select class="form-control select2 pi_receiveduom " disabled id = "pi_receiveduom_' + full.pirId + '"></select>';
                        return html_links;
                    }
                },
                {
                    "mData": "pi_freeQty",
                    "orderable": false,
                    "searchable": false,
                    "render": function (pirId, type, full, meta) {
                        var html_links = '<input type="text" class="form-control text-end pi_freereceivedqty " disabled id="pi_freereceivedqty_' + full.pirId + '" value="' + full.pir_free_qty + '" maxlength = "15" onkeypress="return validateOneDecimalNumeric(this,event);" value="' + full.pir_free_qty + '"  maxlength = "15"  style="max-width:80px !important; min-width:70px !important;"/>';
                        return html_links;
                    }
                },
                {
                    "mData": "pi_freeUOM",
                    "orderable": false,
                    "searchable": false,
                    "render": function (pirId, type, full, meta) {
                        var html_links = '<select class="form-control select2 pi_receiveduom " disabled id = "pi_freereceiveduom_' + full.pirId + '"></select>';
                        return html_links;
                    }
                },
                {
                    "mData": "pirId",
                    "orderable": false,
                    "searchable": false,
                    "render": function (pirId, type, full, meta) {
                        var html_links = '<input type="text" class="form-control pi_batch" disabled id="pi_batch_free_' + full.pirId + '" value="' + full.pir_freeBatch + '" placeholder="Enter Batch" maxlength = "45" />';
                        return html_links;
                    }
                },
                {
                    "mData": "pi_edate",
                    "orderable": false,
                    "searchable": false,
                    "render": function (pirId, type, full, meta) {
                        var html_links = '<input type="text" class="form-control pi_expiry" disabled id="pi_edate_free_' + full.pirId + '" value="' + full.pir_freeExpiry + '" placeholder="DD-MMMM-YYYY" maxlength = "18"  style="max-width:140px !important; min-width:100px !important;" />';
                        return html_links;
                    }
                },
                {
                    "mData": "pirId",
                    "orderable": false,
                    "searchable": false,
                    "render": function (pirId, type, full, meta) {
                        var html_links = '<input type="radio" id="edit_chk_' + full.pirId + '" class="form-control pir_chk" value="0" />';
                        var html_links = '<label class="custom-switch">' +
                            '<input type = "checkbox" name = "custom-switch-checkbox" id="editCheck_' + full.pirId + '" class="custom-switch-input"  onchange="edit_check(editCheck_' + full.pirId + ', event);" >' +
                            '<span class="custom-switch-indicator"></span>' +
                            '</label > ';
                        return html_links;
                    }
                },
                {
                    "mData": "pir_pur_item",
                    "orderable": false,
                    "searchable": false
                },
                {
                    "mData": "pi_bqty",
                    "orderable": false,
                    "searchable": false
                },
                {
                    "mData": "pi_bqty2",
                    "orderable": false,
                    "searchable": false
                },
                {
                    "mData": "pi_bqty3",
                    "orderable": false,
                    "searchable": false
                },
                {
                    "mData": "pi_bqty_uom",
                    "orderable": false,
                    "searchable": false
                },
                {
                    "mData": "pi_bqty2_uom",
                    "orderable": false,
                    "searchable": false
                },
                {
                    "mData": "pi_bqty3_uom",
                    "orderable": false,
                    "searchable": false
                },
                {
                    "mData": "piId",
                    "orderable": false,
                    "searchable": false
                },
                {
                    "mData": "pir_uom",
                    "orderable": false,
                    "searchable": false
                },
                {
                    "mData": "pir_fuom",
                    "orderable": false,
                    "searchable": false
                },
                {
                    "mData": "pir_received",
                    "orderable": false,
                    "searchable": false
                },
                {
                    "mData": "pir_free_qty",
                    "orderable": false,
                    "searchable": false
                },

            ],
            "aoColumnDefs": [
                {
                    "aTargets": [0],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [15],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [16],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [17],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [18],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [19],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [20],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [21],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [22],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [23],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [24],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [25],
                    "visible": false,
                    "searchable": false
                },
                {
                    "aTargets": [26],
                    "visible": false,
                    "searchable": false
                },

            ],
            order: [[0, 'desc']],
            "initComplete": function () {
                LoadUomValues();
            },
            "drawCallback": function () {
                var _date = new Date();
                var d = _date.getDate();
                var m = (_date.getMonth() + 1);
                var y = (_date.getFullYear() + 10);
                $("#tbl_grn_edit tr").each(function () {
                    $('.pi_expiry').bootstrapdatepicker({
                        format: "dd-mm-yyyy",
                        viewMode: "date",
                        todayHighlight: true,
                        autoclose: true,
                        multidate: false,
                        multidateSeparator: "-"
                    });
                    $(".pi_expiry").bootstrapdatepicker("setDate", (d + "-" + m + "-" + y));
                });
                $('.pi_receiveduom').each(function () {
                    var $select = $(this);
                    var piId = $select.attr('id').split('_')[2];
                    if (!$select.hasClass('select2-initialized')) {
                        $select.select2({
                            placeholder: 'Select UOM',
                            width: '100%',
                            dropdownParent: $('#edit_grn_body'),
                            ajax: {
                                url: '@Url.Action("GetEditGRN_UOMDetail", "GRN", new { area = "MaterialManagement" })',
                                dataType: 'json',
                                type: "GET",
                                data: {
                                    pirId: piId,
                                    branch: 1
                                },
                                processResults: function (data) {
                                    var formattedData = [];
                                    for (var i = 0; i < data.length; i++) {
                                        var item = data[i];
                                        var formattedItem = {
                                            id: item.text,
                                            text: item.text
                                        };
                                        formattedData.push(formattedItem);
                                    }

                                    return {
                                        results: formattedData
                                    };
                                }
                            }
                        });

                        $select.addClass('select2-initialized');
                    }
                });

            },
            footerCallback: function (row, data, start, end, display) {
                var api = this.api();

                // Remove the formatting to get integer data for summation
                var intVal = function (i) {
                    return typeof i === 'string' ? i.replace(/[\$,]/g, '') * 1 : typeof i === 'number' ? i : 0;
                };
                var numFormat = $.fn.dataTable.render.number('\,', '.', 2, '').display;

                // Total Amount
                total_qty = api.column(8).data().reduce(function (a, b) { return intVal(a) + intVal(b); }, 0);
                $(api.column(8).footer()).html(numFormat(total_qty));

                // Total Discount
                total_fqty = api.column(10).data().reduce(function (a, b) { return intVal(a) + intVal(b); }, 0);
                $(api.column(10).footer()).html(numFormat(total_fqty));

            }
        });
        table.buttons().container().appendTo('#tbl_grn_edit_wrapper .col-md-6:eq(0)');
        resizedt('tbl_grn_edit');
    }
    function LoadUomValues() {
        $("#tbl_grn_edit tr").each(function () {
            var row = $(this);
            var dataTable = $("#tbl_grn_edit").DataTable();
            var rowIndex = dataTable.row(row).index();

            // Access hidden column values
            var ID = dataTable.cell(rowIndex, 0).data();
            var ruom = dataTable.cell(rowIndex, 23).data();
            var fuom = dataTable.cell(rowIndex, 24).data();

            // Access other visible column values
            var qtyValue = row.find("td:eq(7) input").val();
            var fQtyValue = row.find("td:eq(9) input").val();

            // Load UOM Values
            if (qtyValue != undefined) {
                if (qtyValue > 0) {
                    var newOption = "";
                    newOption = new Option(ruom, ruom, true, true);
                    $("#pi_receiveduom_" + ID).append(newOption).trigger('change');
                }
            }
            if (fQtyValue != undefined) {
                if (fQtyValue > 0) {
                    var newOption = "";
                    newOption = new Option(fuom, fuom, true, true);
                    $("#pi_freereceiveduom_" + ID).append(newOption).trigger('change');
                }
            }

        });
    }
    //#endregion Bind Datatable

    //#region Qty Validion Check
    var checkQtyValidation = function (cval, bal_qty, Oqty, id, rqty) {
        var entered_qty = $("#pi_receivedqty_" + id).val();
        if (entered_qty == "" || entered_qty == null || entered_qty.length == 0 || entered_qty == undefined) {
            entered_qty = 0;
            $("#pi_receivedqty_" + id).val("0");
        }

        if (parseFloat(parseFloat(bal_qty) + parseFloat(rqty)) < parseFloat(entered_qty)) {
            $("#pi_receivedqty_" + id).attr("style", "border:1px solid red;color:red;");
            $.growl.warning({
                title: "Invalid Qty",
                message: "Received Qty should be less than Balance Qty."
            });
        }
        else {
            $("#pi_receivedqty_" + id).attr("style", "border:1px solid #ecebf1;color:#728096;");
        }

        Total_qty = 0;
        $(".pi_receivedqty").each(function () {
            var qty = $(this).val();
            if (qty == "" || qty == null || qty.length == 0 || qty == undefined)
                qty = 0;
            Total_qty += qty;
        });
        $("#r_total_qty").text(Total_qty);
    }
    //#endregion

    //#region Remove Valiate Error Class Timeout
    function Error_Timeout(_id) {
        setTimeout(function () {
            $(".has-error").removeClass("has-error");
            $(".error").removeClass("error");
            $("#" + _id + "-error").text("");
        }, 4200);
    }
    //#endregion

    //#region Update GRN on Button Click
    $('#btn_Update').on('click', function (e) {
        e.preventDefault();
        var itemsValid = GRN_ItemsValid();
        if ($('#form_EditGRN').valid() && itemsValid == 0) {
            Swal.fire({
                title: "Update",
                text: "Are you sure you want to Save Changes!.",
                icon: "question",
                showCancelButton: !0,
                confirmButtonText: 'Yes! I Confirm',
                cancelButtonText: 'No! Cancel Please',
                confirmButtonClass: "btn btn-success mt-2",
                cancelButtonClass: "btn btn-danger ms-2 mt-2",
                buttonsStyling: !1
            }).then(function (t) {
                if (t.value) {
                    var _grn = {
                        "prId": $('#u_hi_prId').val(),
                        "pr_code": $('#u_hi_pr_code').val(),
                        "pr_date": $('#u_pr_date').val(),
                        "pr_PurchaseOrder": $('#u_hi_pr_orderId').val(),
                        "pr_supplier_inv": $('#u_pr_supplier_inv').val(),
                        "pr_branch": $('#u_hi_pr_branch').val(),
                        "pr_notes": $('#u_pr_notes').val(),
                        "pr_supplier_inv_date": $('#u_pr_supplier_inv_date').val().trim(),
                    }
                    var _grn_items = new Array();
                    $("#tbl_grn_edit tbody tr").each(function () {
                        var row = $(this);
                        var dataTable = $("#tbl_grn_edit").DataTable();
                        var rowIndex = dataTable.row(row).index();
                        var _Items = {};

                        let _edate = moment(row.find("td:eq(5) input").val(), 'DD/MM/YYYY').format('MM/DD/YYYY');
                        let _freeExpiry = moment(row.find("td:eq(12) input").val(), 'DD/MM/YYYY').format('MM/DD/YYYY');

                        _Items.pirId = dataTable.cell(rowIndex, 0).data();
                        _Items.pir_ddate = $('#u_pr_date').val();
                        _Items.pir_grnno = $('#u_pr_supplier_inv').val();
                        _Items.pir_received = row.find("td:eq(7) input").val();
                        _Items.pir_batchno = row.find("td:eq(4) input").val();
                        _Items.pir_edate = _edate;
                        _Items.pir_uom = row.find("td:eq(8) select").val();
                        _Items.pir_free_qty = row.find("td:eq(9) input").val();
                        _Items.pir_fuom = row.find("td:eq(10) select").val();
                        _Items.pir_freeBatch = row.find("td:eq(11) input").val();
                        _Items.pir_freeExpiry = _freeExpiry;
                        _Items.pir_uprice = row.find("td:eq(6) input").val().replace(/[,]/g, '');
                        _Items.pir_pur_item = dataTable.cell(rowIndex, 15).data();
                        _Items.pir_bqty = dataTable.cell(rowIndex, 16).data();
                        _Items.pir_bqty2 = dataTable.cell(rowIndex, 17).data();
                        _Items.pir_bqty3 = dataTable.cell(rowIndex, 18).data();
                        _Items.pir_bqty_uom = dataTable.cell(rowIndex, 19).data();
                        _Items.pir_bqty2_uom = dataTable.cell(rowIndex, 20).data();
                        _Items.pir_bqty3_uom = dataTable.cell(rowIndex, 21).data();
                        _Items.pir_piId = dataTable.cell(rowIndex, 22).data();
                        _Items.previous_rqty = dataTable.cell(rowIndex, 25).data();
                        _Items.previous_fqty = dataTable.cell(rowIndex, 26).data();
                        _Items.pir_dcode = $('#u_hi_pr_code').val();
                        _grn_items.push(_Items);

                    });
                    var _dataVal = {
                        grn: _grn,
                        grn_items: _grn_items,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    };
                    $.ajax({
                        url: '@Url.Action("UpdateGRN", "GRN", new { area = "MaterialManagement" })',
                        type: 'POST',
                        dataType: "json",
                        data: _dataVal,
                        beforeSend: function () {
                            $('#btn_Update').removeClass("btn btn-outline-warning");
                            $('#btn_Update').addClass("btn btn-success btn-loaders btn-icon");
                            $('#btn_Update').html("Saving....");
                        },
                        success: function (data) {
                            $('#btn_Update').removeClass("btn btn-success btn-loaders btn-icon");
                            $('#btn_Update').addClass("btn btn-outline-warning");
                            $('#btn_Update').html("Save Changes");
                            if (data.isUpdated) {
                                $('#u_hi_prId').val(data.prId);
                                $('#u_hi_pr_orderCode').val(data.prCode);
                                search_GRN();
                                $('#btn_Update').hide();
                                $("#btn_PrintBarcode").show();
                                $("#btnPrintGRN_edit").show();
                                var alertPlaceholder = document.getElementById("Edit_GRN_Alert");
                                function alert(e, t) {
                                    var l = document.createElement("div");
                                    l.innerHTML = '<div class="alert alert-' + t + ' alert-dismissible" role="alert">' + e +
                                        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-hidden="Close">x</button></div>', alertPlaceholder.append(l)
                                }
                                alert("<i class='fe fe-check-circle text-white'></i>GRN Updated Successfully!", "success");
                                //  $('#purchaseOrder_modal').modal('toggle');
                                Timeout();
                            }
                            else {
                                $("#btn_Update").show();
                                $("#btn_PrintBarcode").hide();
                                $("#btnPrintGRN_edit").hide();
                                $('#u_hi_prId').val("0");
                                $('#u_hi_pur_code').val("");
                                $("#edit_grn_error").html('');
                                var error_message = data.message;
                                if (error_message == "Error While Creating GRN!") {
                                    let html = "<div class='col-12 col-sm-12 col-md-12 d-flex justify-content-center'>" +
                                        "<div class='alert alert-light-warning' role='alert' style=';color:#744f04'>" +
                                        "<button type='button' class='btn-close mr-negative-16' data-bs-dismiss='alert' aria-hidden='true' aria-label='Close'>×</button>" +
                                        "<strong><i class='fe fe-alert-triangle'></i>&nbsp;" + error_message + "&nbsp;</strong></div></div>";
                                    $("#edit_grn_error").html(html);
                                }
                                else {
                                    let html = "<div class='col-12 col-sm-12 col-md-12 d-flex justify-content-center'>" +
                                        "<div class='alert alert-danger' role='alert'>" +
                                        "<button type='button' class='btn-close mr-negative-16' data-bs-dismiss='alert' aria-hidden='true' aria-label='Close'>×</button>" +
                                        "<strong><i class='fe fe-alert-circle text-white' ></i>&nbsp;Validation Error.. Please correct before you submit!&nbsp;</strong><br/><ul>";
                                    $.each(data.message, function (index, value) {
                                        html += "<li><small>" + value + "</small><li>";
                                        var elem = $("#" + index);
                                        if (elem.hasClass("select2-hidden-accessible")) {
                                            $("#select2-" + elem.attr("id") + "-container").parent().addClass('error');
                                        }
                                        else {
                                            $(elem).addClass(" is-invalid");
                                        }
                                        setTimeout(function () {
                                            if (elem.hasClass("select2-hidden-accessible")) {
                                                $("#select2-" + elem.attr("id") + "-container").parent().removeClass('error');
                                            }
                                            else {
                                                $(elem).removeClass("is-invalid");
                                            }
                                        }, 5000);
                                    });
                                    html += "</ul></div></div>";
                                    $("#edit_grn_error").html(html);
                                }
                                Timeout();
                            }
                        },
                        error: function (xhr) {
                            //clearData();
                            $('#btn_Update').removeClass("btn btn-warning btn-loaders btn-icon");
                            $('#btn_Update').addClass("btn btn-warning");
                            $('#btn_Update').html("Confirm & Save");
                            var alertPlaceholder = document.getElementById("Edit_GRN_Alert");
                            function alert(e, t) {
                                var l = document.createElement("div");
                                l.innerHTML = '<div class="alert alert-' + t + ' alert-dismissible" role="alert">' + e +
                                    '<button type="button" class="btn-close text-white" data-bs-dismiss="alert" aria-hidden="true">x</button></div>', alertPlaceholder.append(l)
                            }
                            alert("<i class='fe fe-x-circle text-white'></i> Failed to Update GRN!", "danger");
                            Timeout();
                        }
                    });
                }
            });
        }
        else {
            var alertPlaceholder = document.getElementById("edit_grn_error");
            function alert(e, t) {
                var l = document.createElement("div");
                l.innerHTML = '<div class="alert alert-' + t + ' alert-dismissible" role="alert">' + e +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>', alertPlaceholder.append(l)
            }

            if (itemsValid == -1) {
                alert("<i class='fa fa-exclamation-triangle text-white text-center'></i>&nbsp;Received altleast One Purchase Item.!", "warning");

            }
            else if (itemsValid == -2) {
                alert("<i class='fa fa-exclamation-triangle text-white text-center'></i>&nbsp;Received Qty should be less than Balance Qty!", "warning");
            }
            else {
                //$('.modal-body').animate({
                //    scrollTop: ($('.has-error').offset().top - 300)
                //}, 2000);
                alert("<i class='fa fa-exclamation-triangle text-white text-center'></i>&nbsp;Please Make sure to Fill Mandatory fields in GRN Table!", "warning");
            }
            Timeout();
        }
    });
    //#endregion

    //#region Validate Text Box with One Decimal and numeric only on Key Press
    function validateOneDecimalNumeric(el, evt) {
        var charCode = (evt.which) ? evt.which : event.keyCode;
        var number = el.value.split('.');
        if (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57)) {
            return false;
        }
        //just one dot
        if (number.length > 1 && charCode == 46) {
            return false;
        }
        //get the Current position
        var caratPos = getSelectionStart(el);
        var dotPos = el.value.indexOf(".");
        if (caratPos > dotPos && dotPos > -1 && (number[1].length > 1)) {
            return false;
        }
        return true;
    }
    function getSelectionStart(o) {
        if (o.createTextRange) {
            var r = document.selection.createRange().duplicate()
            r.moveEnd('character', o.value.length)
            if (r.text == '') return o.value.length
            return o.value.lastIndexOf(r.text)
        } else return o.selectionStart
    }
    //#endregion

    //#region Validation on GRN Items Table
    var GRN_ItemsValid = function () {
        var count = 0;
        var Rows_count = 0;
        var qty_exceed = 0;
        var unit_price = 0;

        var table = $("#tbl_grn_edit").DataTable();
        var rows = table.rows().data().toArray();
        if (rows.length > 0) {
            $.each(rows, function (index, rowId) {

                var _data = table.row(index).data();
                var id = _data.pirId;
                var bal_qty = _data.pi_bqty;
                var bal_uom = _data.pi_bqty_uom;
                var received_qty = $("#pi_receivedqty_" + id).val();
                var Free_received_qty = $("#pi_freereceivedqty_" + id).val();
                var unit_price = $("#pi_uprice_" + id).val();

                var previous_rQty =  table.cell(index, 25).data();
                var previous_fQty = table.cell(index, 26).data();


                if (parseFloat(received_qty) > 0) {
                    if ($("#pi_batch_" + id).val() == null || $("#pi_batch_" + id).val().trim() == "" || $("#pi_batch_" + id).val() == undefined || $("#pi_batch_" + id).val().length == 0) {
                        $("#pi_batch_" + id).parent().addClass('has-error');
                        Error_Timeout("pi_batch_" + id);
                        count++;
                    }
                    if ($("#pi_edate_" + id).val() == null || $("#pi_edate_" + id).val().trim() == "" || $("#pi_edate_" + id).val() == undefined || $("#pi_edate_" + id).val().length == 0) {
                        $("#pi_edate_" + id).parent().addClass('has-error');
                        Error_Timeout("pi_edate_" + id);
                        count++;
                    }
                    if ($("#pi_receiveduom_" + id).val() == null || $("#pi_receiveduom_" + id).val() == "" || $("#pi_receiveduom_" + id).val() == undefined || $("#pi_receiveduom_" + id).val().length == 0) {
                        $("#select2-pi_receiveduom_" + id + "-container").parent().addClass('error');
                        Error_Timeout("pi_receiveduom_" + id);
                        count++;
                    }
                    if ($("#pi_uprice_" + id).val() == null || $("#pi_uprice_" + id).val().trim() == "" || $("#pi_uprice_" + id).val() == undefined || $("#pi_uprice_" + id).val().length == 0 || $("#pi_uprice_" + id).val().trim() == 0) {
                        $("#pi_uprice_" + id).parent().addClass('has-error');
                        Error_Timeout("pi_uprice_" + id);
                        count++;
                    }
                    if (received_qty > (bal_qty + previous_rQty)) {
                        qty_exceed++;
                    }
                    Rows_count++;
                }
                if (parseFloat(Free_received_qty) > 0) {
                    if ($("#pi_batch_free_" + id).val() == null || $("#pi_batch_free_" + id).val().trim() == "" || $("#pi_batch_free_" + id).val() == undefined || $("#pi_batch_free_" + id).val().length == 0) {
                        $("#pi_batch_free_" + id).parent().addClass('has-error');
                        Error_Timeout("pi_batch_free_" + id);
                        count++;
                    }
                    if ($("#pi_edate_free_" + id).val() == null || $("#pi_edate_free_" + id).val().trim() == "" || $("#pi_edate_free_" + id).val() == undefined || $("#pi_edate_free_" + id).val().length == 0) {
                        $("#pi_edate_free_" + id).parent().addClass('has-error');
                        Error_Timeout("pi_edate_free_" + id);
                        count++;
                    }
                    if ($("#pi_freereceiveduom_" + id).val() == null || $("#pi_freereceiveduom_" + id).val() == "" || $("#pi_freereceiveduom_" + id).val() == undefined || $("#pi_freereceiveduom_" + id).val().length == 0) {
                        $("#select2-pi_freereceiveduom_" + id + "-container").parent().addClass('error');
                        Error_Timeout("pi_freereceiveduom_" + id);
                        count++;

                    }
                    Rows_count++;
                }
            });
        }
        if (Rows_count == 0) {
            count = -1;
        }
        if (qty_exceed > 0) {
            count = -2;
        }
        return count;
    }
    //#endregion

    //#region Enable Disable GRN Items Edit
    var edit_check = function (el, evt) {
        var id = el.id.split('_')[1];
        if ($(el).is(':checked')) {
            enable_disable("remove", "pi_edate_" + id);
            enable_disable("remove", "pi_uprice_" + id);
            enable_disable("remove", "pi_receivedqty_" + id);
            enable_disable("remove", "pi_receiveduom_" + id);
            enable_disable("remove", "pi_freereceivedqty_" + id);
            enable_disable("remove", "pi_freereceiveduom_" + id);
            enable_disable("remove", "pi_batch_free_" + id);
            enable_disable("remove", "pi_edate_free_" + id);
            enable_disable("remove", "pi_batch_" + id);
        }
        else {
            enable_disable("add", "pi_batch_" + id);
            enable_disable("add", "pi_edate_" + id);
            enable_disable("add", "pi_uprice_" + id);
            enable_disable("add", "pi_receivedqty_" + id);
            enable_disable("add", "pi_receiveduom_" + id);
            enable_disable("add", "pi_freereceivedqty_" + id);
            enable_disable("add", "pi_freereceiveduom_" + id);
            enable_disable("add", "pi_batch_free_" + id);
            enable_disable("add", "pi_edate_free_" + id);
        }
    };
    var enable_disable = function (type, id)
    {
        if (type == "remove")
            $("#" + id).removeAttr("disabled");
        else
            $("#" + id).attr("disabled", "disabled");

    }
    //#endregion

    //#region Print Goods Received Note
    $("#btnPrintGRN_edit").on('click', function () {
        var prId = $("#u_hi_prId").val();
        var pr_branch = $("#u_hi_pr_branch").val();
        window.open("@Url.Action("PrintGoodsReceivedNote", "GRN", new { area = "MaterialManagement" })?prId=" + prId + "&pr_branch=" + pr_branch, "Goods Received Notes Print");
    });

    //#endregion

    //#region Print Single GRN Barcode

    $("#btn_PrintBarcode").on('click', function () {
        print_barcode($("#u_hi_pr_code").val());
    });

        var print_barcode = function (pr_code) {
                Swal.fire({
                    title: "Barcode Print",
                    text: "Are you sure you want to Print GRN's Barcode",
                    icon: "question",
                    showCancelButton: !0,
                    confirmButtonText: 'Yes! I Confirm',
                    cancelButtonText: 'No! Cancel Please',
                    confirmButtonClass: "btn btn-success mt-2",
                    cancelButtonClass: "btn btn-danger ms-2 mt-2",
                    buttonsStyling: !1
                }).then(function (t) {
                    if (t.value) {
                        FunPrintBarcode(pr_code);
                    }
                });


        }
        var FunPrintBarcode = function (pr_code) {
            $.ajax({
                url: '@Url.Action("PrintBarcodeService", "GRN", new { area = "MaterialManagement" })?pr_code=' + pr_code,
                type: "POST",
                dataType: "json",
                async: false,
                success: function (response) {
                    if (response.isSuccess == true) {
                        if (response.data["status"] == "success") {
                            event.preventDefault();
                            event.stopPropagation();
                            return $.growl.notice({
                                title: "Success",
                                message: response.message
                            });
                        }
                        else {
                            event.preventDefault();
                            event.stopPropagation();
                            return $.growl.warning({
                                title: "Pending",
                                message: response.message
                            });
                        }
                    }
                    else {
                        event.preventDefault();
                        event.stopPropagation();
                        return $.growl.error({
                            title: "Error",
                            message: response.message
                        });
                    }
                },
                error: function (xhr) {
                    console.log("Error : " + xhr.statusText);
                }
            });
        }
        //#endregion

</script>
