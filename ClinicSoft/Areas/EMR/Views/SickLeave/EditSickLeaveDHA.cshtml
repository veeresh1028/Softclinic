
@using System.Linq;
@using System.Security.Claims;
@using BusinessEntities;
@model BusinessEntities.EMR.SickLeaveDHA
@{
    var claims = ClaimsPrincipal.Current.Identities.First().Claims.ToList();
    var emp_designation = claims.Where(c => c.Type == ClaimTypes.Role).Select(c => c.Value).SingleOrDefault();
    EMRInfo emr = (EMRInfo)TempData["emr_data"];
    TempData.Keep("emr_data");
}
<form id="form_EditDentHis" class="needs-validation" >

    @Html.AntiForgeryToken()
    @Html.HiddenFor(m => m.slmId)
    @Html.HiddenFor(m => m.slm_appId)
    @Html.HiddenFor(m => m.slmId, new { @id = "uslmId", @value = "@Model.slmId" })
    <div class="row">
        <div class="col-sm-12 col-md-6 col-lg-12 mb-4 ">

            <div class="row">
                <div class="col-sm-12 col-md-6 col-lg-12">
                    <div class="row border ">
                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <div class="row">
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <div class="form-group mb-3"><label class="form-label text-black text-align-left"> Patient Name:&nbsp;<span class="text-danger"> *</span></label></div>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <label class="form-label text-black text-left text-capitalize">@emr.pat_name&nbsp;</label>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <div class="form-group mb-3"><label class="form-label text-black"> Emirates ID Number*/Passport No.&nbsp;<span class="text-danger"> *</span></label></div>
                                </div>
                                <div class="col-sm-6 col-md-6 col-lg-2">
                                    <label class="form-label text-black text-left">@emr.pat_emirateid&nbsp;</label>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <div class="form-group mb-3"><label class="form-label text-black">Place of Employement&nbsp;</label></div>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <label class="form-label text-black text-left">@emr.pat_city&nbsp;</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <div class="form-group mb-3 text-align-left"><label class="form-label text-black ">Medical Record Number&nbsp;<span class="text-danger"> *</span></label></div>

                                </div>

                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <label class="form-label text-black text-left">@emr.pat_code&nbsp;</label>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <div class="form-group mb-3"><label class="form-label text-black"> 	Date of Birth&nbsp;<span class="text-danger"> *</span></label></div>

                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <label class="form-label text-black text-left">@emr.pat_dob&nbsp;</label>
                                </div>

                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <div class="form-group mb-3"><label class="form-label text-black">Date of Visit&nbsp;<span class="text-danger"> *</span></label></div>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <label class="form-label text-black text-left">@emr.app_fdate&nbsp;</label>
                                </div>

                            </div>

                        </div>
                    </div>

                </div>
            </div>
            <div class="row mb-5 mt-5">
                <div class="expanel-heading mb-2">
                    <div class="row">
                        <div class="col-sm-12 col-md-6 col-lg-12">
                            <div class="form-group mb-3"><label class="form-label ">Information&nbsp;</label></div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-12">
                    <div class="form-group">
                        <label class="form-label">Type of work: (Tick Appropriate)&nbsp;</label>
                        <div class="custom-controls d-lg-flex d-md-flex flex-row justify-content-left">
                            <label class="custom-control custom-checkbox ms-sm-2 md-md-2 ms-lg-2">
                                <input type="checkbox" class="custom-control-input" name="uslm_1" value="1" id="uslm_11">
                                <span class="custom-control-label">Light/Moderate (office, sales, mild physical, etc.)</span>
                            </label>
                            <label class="custom-control custom-checkbox ms-sm-2 md-md-2 ms-lg-2">
                                <input type="checkbox" class="custom-control-input" name="uslm_1" value="2" id="uslm_12">
                                <span class="custom-control-label">Moderate (Police, construction, moderate physical work, etc.)</span>
                            </label>
                            <label class="custom-control custom-checkbox ms-sm-2 md-md-2 ms-lg-2">
                                <input type="checkbox" class="custom-control-input" name="uslm_1" value="3" id="uslm_13">
                                <span class="custom-control-label">Heavy (Army, Heavy physical work, airline pilot, etc)</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-12">
                    <div class="form-group">
                        <label class="form-label">Visit Type: (Tick Appropriate)&nbsp;</label>
                        <div class="custom-controls d-lg-flex d-md-flex flex-row justify-content-left">
                            <label class="custom-control custom-checkbox ms-sm-2 md-md-2 ms-lg-2">
                                <input type="checkbox" class="custom-control-input" name="uslm_1" value="4" id="uslm_14">
                                <span class="custom-control-label">Outpatient</span>
                            </label>
                            <label class="custom-control custom-checkbox ms-sm-2 md-md-2 ms-lg-2">
                                <input type="checkbox" class="custom-control-input" name="uslm_1" value="5" id="uslm_15">
                                <span class="custom-control-label">Inpatient</span>
                            </label>
                            <label class="custom-control custom-checkbox ms-sm-2 md-md-2 ms-lg-2">
                                <input type="checkbox" class="custom-control-input" name="uslm_1" value="6" id="uslm_16">
                                <span class="custom-control-label">Medical</span>
                            </label>
                            <label class="custom-control custom-checkbox ms-sm-2 md-md-2 ms-lg-2">
                                <input type="checkbox" class="custom-control-input" name="uslm_1" value="7" id="uslm_17">
                                <span class="custom-control-label">Surgical</span>
                            </label>
                            <label class="custom-control custom-checkbox ms-sm-2 md-md-2 ms-lg-2">
                                <input type="checkbox" class="custom-control-input" name="uslm_1" value="8" id="uslm_18">
                                <span class="custom-control-label">Consultation</span>
                            </label>
                            <label class="custom-control custom-checkbox ms-sm-2 md-md-2 ms-lg-2">
                                <input type="checkbox" class="custom-control-input" name="uslm_1" value="9" id="uslm_19">
                                <span class="custom-control-label">Procedure</span>
                            </label>
                            <label class="custom-control custom-checkbox ms-sm-2 md-md-2 ms-lg-2">
                                <input type="checkbox" class="custom-control-input" name="uslm_1" value="10" id="uslm_110">
                                <span class="custom-control-label">Follow Up</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-12">
                    <div class="form-group">
                        <label class="form-label">ICD 10 Code/Diagnosis&nbsp;<span class="text-danger"> *</span></label>
                        <label class="form-label" id="upat_Diagnosis" name="">&nbsp;</label>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-12">
                    <div class="form-group">
                        <label class="form-label">CPT Code/Procedure&nbsp;<span class="text-danger"> *</span></label>
                        <label class="form-label" id="utreat_details" name="">&nbsp;</label>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-4">
                    <div class="form-group mb-3">
                        <label class="form-label">SIck Leave DHA From&nbsp;<span class="text-danger"> *</span></label>
                        <div class="form-group mb-3 text-center">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <i class="fe fe-calendar"></i>
                                    </div>
                                </div>
                                @Html.TextBoxFor(m => m.slm_2, new { @class = "form-control", @placeholder = "DD-MMMM-YYYY", @id = "uslm_2" })
                            </div>

                        </div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-4">
                    <div class="form-group">
                        <label class="form-label">SIck Leave DHA To&nbsp;<span class="text-danger"> *</span></label>
                        <div class="form-group mb-3 text-center">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <i class="fe fe-calendar"></i>
                                    </div>
                                </div>
                                @Html.TextBoxFor(m => m.slm_3, new { @class = "form-control", @placeholder = "DD-MMMM-YYYY", @id = "uslm_3" })
                            </div>

                        </div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-4">
                    <div class="form-group mb-3">
                        <label class="form-label">Number of Days&nbsp;<span class="text-danger"> *</span></label>
                        @Html.TextBoxFor(m => m.slm_4, new { @class = "form-control", @placeholder = "Enter No Of Days:", @id = "uslm_4" })
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-4">
                    <div class="form-group mb-3">
                        <label class="form-label">Physician's Name&nbsp;<span class="text-danger"> *</span></label>
                        <span class="text-capitalize text-left text-black">@emr.doc_name&nbsp;</span>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-4">
                    <div class="form-group">
                        <label class="form-label">DHCC License Number&nbsp;<span class="text-danger"> *</span></label>
                        <span class="text-capitalize text-left text-black">@emr.emp_license&nbsp;</span>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-4">
                    <div class="form-group mb-3">
                        <label class="form-label">Signature&Stamp&nbsp;<span class="text-danger"> *</span></label>
                        <img alt="stamp" src="@emr.doc_sign" id="doc_sign" class="avatar avatar-xl bsquare" />
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-6 expanel-heading">
                    <div class="form-group mb-3">
                        <label class="form-label text-black">For CPQ Office Use:</label>
                        <label class="form-label text-black"></label>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-6 expanel-heading">
                    <div class="form-group mb-3">
                        <label class="form-label text-black"> Place SIck Leave DHA token here:</label>
                        <label class="form-label text-black">
                            Tokens are available from DHCC
                            Cashier Office
                        </label>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-12">
                    <div class="form-group mb-3">
                        <label class="form-label text-black">This SIck Leave DHA certificate is to be attested by Dubai Healthcare City Authority at the offices of the Center for Healthcare Planning and Quality, ground floor, Block C, Building 27, Dubai Healthcare City.</label>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-12">
                    <div class="form-group mb-3">
                        <label class="form-label text-black">For Use in Dubai HealthCare City healthcare facilities only.</label>
                    </div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-sm-12 col-md-6 col-lg-12 text-center">
                    <div class="btn-list btn-animation">
                        <button type="submit" class="btn btn-sm btn-warning" id="btn_Update_LeaveDHA">Save Changes</button>
                        <button type="submit" class="btn btn-sm btn-outline-danger" id="btn_Delete_LeaveDHA">Delete</button>
                        <button type="submit" class="btn btn-sm btn-outline-light" id="btn_Print_LeaveDHA" onclick="PrintSickLeaveDHA(@Model.slmId)">
                            <i class="fa fa-print">&nbsp;&nbsp;</i>Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>


<script>
    //#region Page Load
        $(function () {

            if ("@emp_designation.ToString()" === "Super Administrator") {
                $("#btn_Update_LeaveDHA,#btn_Delete_LeaveDHA").show();
            } else {
                if ("@emr.set_emr_lock" == "NoLock") {
                    $("#btn_Update_LeaveDHA,#btn_Delete_LeaveDHA").show();

                }
                else {
                    if ("@emr.app_ae_date" >= "@emr.today") {
                        $("#btn_Update_LeaveDHA,#btn_Delete_LeaveDHA").show();
                    }
                    else {
                        $("#btn_Update_LeaveDHA,#btn_Delete_LeaveDHA").hide();
                    }
                }
            }
            $('#uslm_2,#uslm_3').bootstrapdatepicker({
                format: "dd-MM-yyyy",
                viewMode: "date",
                todayHighlight: true,
                autoclose: true,
                multidate: false,
                multidateSeparator: "-"
            });

            $("#uslm_2").bootstrapdatepicker("setDate", moment(new Date("@Model.slm_2")).format("DD-MMMM-YYYY"));
            $("#uslm_3").bootstrapdatepicker("setDate", moment(new Date("@Model.slm_3")).format("DD-MMMM-YYYY"));

            Get_AllPatientDiagnosis();
            Get_Patient_Treatments();
            GetCheckedValues();
            validate();

        });

    //#endregion Page Load

    //#region Get CheckedValues
     var GetCheckedValues = function (checknames) {
     var checknames = "@Model.slm_1";

       if (checknames !== null) {

         if (checknames != "") {
          var str = "@Model.slm_1";
          var myarray = str.split(',');
          for (var i = 0; i < myarray.length; i++) {
             $('.custom-control-input').each(function () {
                 if (myarray.includes($(this).val())) {
                     $(this).prop("checked", true);
                 }
             });
         }
         console.log(myarray)
        }
      }
    }
    //#endregion

    @*//#region Get CheckedValues
    var GetCheckedValues = function () {
        var slm_1_ = "@Model.slm_1";
        if (slm_1_ !== "") {
            var uslm_1_ = $("input[name='uslm_1'][value='" + "@Model.slm_1" + "']").attr("id");
            $("#" + uslm_1_).attr('checked', 'checked');
            $("#" + uslm_1_).prop("checked", true);
        }
    }*@

    //#region Load Get All Diagnosis
        var Get_AllPatientDiagnosis = function () {
            $.ajax({
                type: "GET",
                url: "@Url.Action("GetAllPatientDiagnosis", "ReimbursementForms", new { area = "EMRForms" })?appId=" + "@emr.appId" + "&patId=" + @emr.patId,
                success: function (response) {
                    if (response.length > 0) {
                        $('#upat_Diagnosis').text(response[0].Diagnosis);
                    }
                },
                error: function (xhr) {
                    console.log(xhr);
                }
            })
        }
    //#endregion

    //#region Load Get_Patient_Treatments
        var Get_Patient_Treatments = function () {
             $.ajax({
                type: "GET",
                url: "@Url.Action("Get_Patient_Treatment", "ReimbursementForms", new { area = "EMRForms" })?appId=" +@emr.appId,
                success: function (response) {
                    if (response.length > 0) {
                        $('#utreat_details').text(response[0].treatments);
                    }
                },
                error: function (xhr) {
                    console.log(xhr);
                }
             });
         }
    //#endregion

    //#region Update  Button Click
        $('#btn_Update_LeaveDHA').on('click', function (e) {
             e.preventDefault();
            if ($("#form_EditDentHis").valid()) {
                $('#btn_Update_LeaveDHA').removeClass("btn btn-sm btn-success");
                $('#btn_Update_LeaveDHA').addClass("btn btn-sm btn-success btn-loaders btn-icon");
                $('#btn_Update_LeaveDHA').html("Updating the Record....");
                 var uslm_1_ = $.map($(':checkbox[name=uslm_1]:checked'), function (n, i) {
                    return n.value;
                }).join(',');
                var _dataInsert = {
                    "slmId": @Model.slmId,
                    "slm_appId": $("#slm_appId").val(),
                    "slm_1": uslm_1_,
                    "slm_2": $("#uslm_2").val(),
                    "slm_3": $("#uslm_3").val(),
                    "slm_4": $("#uslm_4").val(),
                    "__RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                }
                console.log(_dataInsert)
                $.ajax({
                    type: "POST",
                    url: "@Url.Action("UpdateSickLeaveDHA", "SickLeave", new { area = "EMR" })",
                    dataType: 'JSON',
                    data: _dataInsert,
                    success: function (data) {
                        $('#btn_Update_LeaveDHA').removeClass("btn btn-sm btn-warning btn-loaders btn-icon");
                        $('#btn_Update_LeaveDHA').addClass("btn btn-sm btn-warning");
                        $('#btn_Update_LeaveDHA').html("Save Changes");
                        if (data.isSuccess) {
                            if (data.isInserted) {
                                var alertPlaceholder = document.getElementById("Alert");
                                function alert(e, t) {
                                    var l = document.createElement("div");
                                    l.innerHTML = '<div class="alert alert-' + t + ' alert-dismissible" role="alert">' + e +
                                        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-hidden="Close">x</button></div>', alertPlaceholder.append(l)
                                }
                                alert("<i class='fe fe-check-circle text-white'></i> Sick Leave DHA Updated Successfully!", "success");
                                Timeout();
                                GetSickLeaveDHA();
                            }
                            else {
                                let html = "<div class='col-12 col-sm-12 col-md-12 d-flex justify-content-center'>" +
                                    "<div class='alert alert-warning' role='alert'>" +
                                    "<button type='button' class='btn-close mr-negative-16' data-bs-dismiss='alert' aria-hidden='true' aria-label='Close'>×</button>" +
                                    "<strong>Warning.. Sick Leave DHA Alredy Exists..</strong><br/>" +
                                    "</div></div>";
                                $("#error").html(html);
                            }
                        }
                        else {
                            let html = "<div class='col-12 col-sm-12 col-md-12 d-flex justify-content-center'>" +
                                "<div class='alert alert-danger' role='alert'>" +
                                "<button type='button' class='btn-close mr-negative-16' data-bs-dismiss='alert' aria-hidden='true' aria-label='Close'>×</button>" +
                                "<strong>Validation Error.. Please correct before you submit the form!&nbsp;</strong><br/><ul>";
                            $.each(data.message, function (index, value) {
                                html += "<li><small>" + value + "</small><li>";
                                var elem = $("#" + index);
                                if (elem.hasClass("select2-hidden-accessible")) {
                                    $("#select2-" + elem.attr("id") + "-container").parent().addClass('error');
                                }
                                else {
                                    $(elem).addClass(" is-invalid");
                                }

                                setTimeout(function () {
                                    if (elem.hasClass("select2-hidden-accessible")) {
                                        $("#select2-" + elem.attr("id") + "-container").parent().removeClass('error');
                                    }
                                    else {
                                        $(elem).removeClass("is-invalid");
                                    }
                                }, 5000);
                            });
                            html += "</ul></div></div>";
                            $("#error").html(html);
                        }
                    },
                    error: function (xhr) {
                        $('#btn_Update_LeaveDHA').removeClass("btn btn-sm btn-warning btn-loaders btn-icon");
                        $('#btn_Update_LeaveDHA').addClass("btn btn-sm btn-warning");
                        $('#btn_Update_LeaveDHA').html("Save Changes");
                        Timeout();
                    }
                });
            }
            else {
                $('.modal-body').animate({
                    scrollTop: ($('.has-error').offset().top - 300)
                }, 2000);
            }
        });
    //#endregion Update  Button Click


    //#region Delete Click
        $('#btn_Delete_LeaveDHA').on('click', function (e) {
            e.preventDefault();
            $('#btn_Delete_LeaveDHA').removeClass("btn btn-sm btn-success");
            $('#btn_Delete_LeaveDHA').addClass("btn btn-sm btn-success btn-loaders btn-icon");
            $('#btn_Delete_LeaveDHA').html("Deleting the Record....");

                $.ajax({
                    url: '@Url.Action("DeleteSickLeaveDHA", "SickLeave", new { area = "EMR" })?slmId=' + @Model.slmId,
                    type: "POST",
                    dataType: 'JSON',
                    success: function (data) {
                        $('#btn_Delete_LeaveDHA').removeClass("btn btn-sm btn-success btn-loaders btn-icon");
                        $('#btn_Delete_LeaveDHA').addClass("btn btn-sm btn-warning");
                        $('#btn_Delete_LeaveDHA').html("Delete");
                        if (data.isAuthorized) {
                            if (data.success) {
                                var alertPlaceholder = document.getElementById("Alert");
                                function alert(e, t) {
                                    var l = document.createElement("div");
                                    l.innerHTML = '<div class="alert alert-' + t + ' alert-dismissible" role="alert">' + e +
                                        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-hidden="Close">x</button></div>', alertPlaceholder.append(l)
                                }
                                alert("<i class='fe fe-check-circle text-white'></i> Sick Leave DHA Deleted Successfully!", "success");
                                clearControls();
                                GetSickLeaveDHA();
                                Timeout();
                            }
                            else {
                                let html = "<div class='col-12 col-sm-12 col-md-12 d-flex justify-content-center'>" +
                                    "<div class='alert alert-warning' role='alert'>" +
                                    "<button type='button' class='btn-close mr-negative-16' data-bs-dismiss='alert' aria-hidden='true' aria-label='Close'>×</button>" +
                                    "<strong>Error!.. Failed to Delete..</strong><br/>" +
                                    "</div></div>";
                                $("#error").html(html);
                            }
                        }
                        else {
                            var alertPlaceholder = document.getElementById("Alert");
                            function alert(e, t) {
                                var l = document.createElement("div");
                                l.innerHTML = '<div class="alert alert-' + t + ' alert-dismissible" role="alert">' + e +
                                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-hidden="Close">x</button></div>', alertPlaceholder.append(l)
                            }
                            alert("<i class='fe fe-check-circle text-white'></i> You do not have Enough Privileges to Delete this Designation!", "Access Denied!");
                        }
                    },
                    error: function (xhr) {
                        $('#btn_Delete_LeaveDHA').removeClass("btn btn-sm btn-success btn-loaders btn-icon");
                        $('#btn_Delete_LeaveDHA').addClass("btn btn-sm btn-Delete");
                        $('#btn_Delete_LeaveDHA').html("Delete");
                        Timeout();
                    }
                })
        });
    //#endregion Delete Click

    //#region Validation Initialization
        var validate = function () {

            $("#form_EditDentHis").validate({
                rules: {
                    uslm_rest: {
                        required: true
                    },

                },
                messages: {
                    uslm_rest: {
                        required: "Please Other Past History!"
                    },

                },
                highlight: function (element) {
                    var elem = $(element);
                    $(element).parent().addClass('has-error');
                    error_timeout(elem.attr("id"));
                },
                unhighlight: function (element) {
                    var elem = $(element);
                    $(element).parent().removeClass('has-error');
                },
                errorElement: 'span',
                errorClass: 'text-danger fw-bold',
                errorPlacement: function (error, element) {
                    var elem = $(element);
                    if (element.parent('.input-group').length) {
                        error.insertAfter(element.parent());
                    } else {
                        error.insertAfter(element);
                    }
                }
            });

        }
    //#endregion Validation Initialization

    //#region Clear Controls
        var clearControls = function () {
            $(".form-control").val("");
            $(".custom-control-input").prop("checked", false);

        }
    //#endregion Clear Controls
</script>

