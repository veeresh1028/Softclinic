@model BusinessEntities.EMR.PackageBillingModel
<div class="modal-header py-3 px-4  bg-light">
    <span class="badge bg-primary-light-1 text-uppercase"> @Model.PackageOrder.po_packagename - @Model.PackageOrder.po_packageprice </span>
    <button type="button" class="btn-close close-modal" data-bs-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<div class="modal-body p-4">
    <div class="col-12 col-sm-12 col-md-12 d-flex justify-content-center">
        <div id="billingAlert"></div>
    </div>
    <form id="form_quick_cash_pack" >
        <div id="divReceipt">
            <div aria-multiselectable="true" class="accordion" id="accordion" role="tablist">
                <div class="acc-card mb-2">
                    <div class="acc-header" id="headingOne" role="tab">
                        <h5 class="mb-0">
                            <a aria-controls="collapseOne" aria-expanded="true" data-bs-toggle="collapse" href="#collapseOne" class="bg-danger text-white border-danger">
                                <span class="text-white">Pay <label class="col-2" placeholder="0.00" type="text" id="total_price_display"></label></span>
                            </a>
                        </h5>
                    </div>
                    <div aria-labelledby="headingOne" class="collapse" data-parent="#accordion" id="collapseOne" role="tabpanel">
                        <div class="acc-body">
                            <h3 class="card-title">Pay By :</h3>

                            <div class="row mb-2">
                                <div class="col-lg-12 col-md-12 col-sm-12 text-start">
                                    <div class="form-group font-weight-bold">
                                        <label class="custom-switch">
                                            <span class="custom-switch-description me-2 font-weight-bold text-dark">Cheque</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(3, $(this).is(':checked'))">
                                            <span class="custom-switch-indicator custom-switch-indicator-secondary"></span>
                                        </label>

                                        <label class="custom-switch">
                                            <span class="custom-switch-description me-2 font-weight-bold text-dark">Bank Transfer</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(4, $(this).is(':checked'))">
                                            <span class="custom-switch-indicator custom-switch-indicator-warning"></span>
                                        </label>

                                        <label class="custom-switch">
                                            <span class="custom-switch-description me-2 font-weight-bold text-dark">Advance</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(5, $(this).is(':checked'))" checked="checked">
                                            <span class="custom-switch-indicator custom-switch-indicator-danger"></span>
                                        </label>

                                        <label class="custom-switch d-none">
                                            <span class="custom-switch-description me-2 font-weight-bold text-dark">Voucher</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(6, $(this).is(':checked'))">
                                            <span class="custom-switch-indicator custom-switch-indicator-dark"></span>
                                        </label>

                                        <label class="custom-switch d-none">
                                            <span class="custom-switch-description me-2 font-weight-bold text-dark">Loyalty</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(7, $(this).is(':checked'))">
                                            <span class="custom-switch-indicator custom-switch-indicator-success"></span>
                                        </label>
                                        <label class="custom-switch">
                                            <span class="custom-switch-description me-2 font-weight-bold text-dark">Bad Debit</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(8, $(this).is(':checked'))">
                                            <span class="custom-switch-indicator custom-switch-indicator-info"></span>
                                        </label>
                                        <label class="custom-switch">
                                            <span class="custom-switch-description me-2 font-weight-bold text-dark">Tabby</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(9, $(this).is(':checked'))" checked="checked">
                                            <span class="custom-switch-indicator custom-switch-indicator-secondary"></span>
                                        </label>
                                        <label class="custom-switch d-none">
                                            <span class="custom-switch-description me-2 font-weight-bold text-dark">Selfologi</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(10, $(this).is(':checked'))">
                                            <span class="custom-switch-indicator custom-switch-indicator-warning"></span>
                                        </label>
                                        <label class="custom-switch d-none">
                                            <span class="custom-switch-description me-2 font-weight-bold text-dark">Spotii</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(11, $(this).is(':checked'))">
                                            <span class="custom-switch-indicator custom-switch-indicator-danger"></span>
                                        </label>
                                        <label class="custom-switch d-none">
                                            <span class="custom-switch-description me-2 font-weight-bold text-dark">Cobone</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(12, $(this).is(':checked'))">
                                            <span class="custom-switch-indicator custom-switch-indicator-dark"></span>
                                        </label>
                                        <label class="custom-switch d-none">
                                            <span class="custom-switch-description me-2 font-weight-bold text-dark">Groupon</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(13, $(this).is(':checked'))">
                                            <span class="custom-switch-indicator custom-switch-indicator-success"></span>
                                        </label>
                                        <label class="custom-switch d-none">
                                            <span class="custom-switch-description ms-0 me-2 font-weight-bold text-dark">Stripe</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(14, $(this).is(':checked'))">
                                            <span class="custom-switch-indicator custom-switch-indicator-info"></span>
                                        </label>
                                        <label class="custom-switch">
                                            <span class="custom-switch-description ms-0 me-2 font-weight-bold text-dark">Tamara</span>
                                            <input type="checkbox" name="custom-switch-checkbox1" class="custom-switch-input" onchange="payby(15, $(this).is(':checked'))" checked="checked">
                                            <span class="custom-switch-indicator custom-switch-indicator-secondary"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-1">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Cash</span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_cash" name="rec_cash" oninput="validate(this,0)">
                                    </div>
                                </div>

                                <div class="col-md-1">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Credit Card  </span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_cc" name="rec_cc" oninput="validate(this,0)">
                                    </div>
                                </div>
                                <div class="col-md-1 d-none">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Chrg. (%)</span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_cc_per" name="rec_cc_per" oninput="validate(this,0)">
                                    </div>
                                </div>

                                <div class="col-md-1 d-none" id="divCq">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Cheque Amt. </span></label>
                                        <input class="form-control font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_chq" name="rec_chq" oninput="validate(this,0)">
                                    </div>
                                </div>
                                <div class="col-md-2 d-none" id="divCqNo">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Cheque No. </span></label>
                                        <input class="form-control font-weight-semibold" placeholder="Eg:123456" type="text" id="rec_chq_no" name="rec_chq_no">
                                    </div>
                                </div>
                                <div class="col-md-2 d-none" id="divCqBank">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Bank Name </span></label>
                                        <input class="form-control font-weight-semibold" placeholder="Eg:ADCB" type="text" id="rec_chq_bank" name="rec_chq_bank">
                                    </div>
                                </div>
                                <div class="col-md-2 d-none" id="divCqDate">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Cheque Date </span></label>
                                        <input type="text" id="rec_chq_date" class="form-control font-weight-semibold" placeholder="Ex:DD-MMM-YYYY" />
                                    </div>
                                </div>
                                <div class="col-md-1 d-none" id="divBT">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Bank Transfer </span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_bt" name="rec_bt" oninput="validate(this,0)">
                                    </div>
                                </div>
                                <div class="col-md-2 d-none" id="divBT_Bank">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Bank Name </span></label>
                                        <select class="form-select select2" id="rec_bt_bank"></select>
                                    </div>
                                </div>
                                <div class="col-md-2" id="divAdv">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Advance </span></label>
                                        <select class="form-select select2" id="rec_advance"></select>
                                    </div>
                                </div>
                                <div class="col-md-1" id="divAdvName">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Allocated </span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_allocated" name="rec_allocated" oninput="validate(this,0)">
                                    </div>
                                </div>
                                <div class="col-md-2 d-none" id="divVou">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Voucher </span></label>
                                        <select class="form-select select2" id="rec_voucher"></select>
                                    </div>
                                </div>
                                <div class="col-md-2 d-none" id="divLoy">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Loyalty </span></label>
                                        <select class="form-select select2" id="rec_loyalty"></select>
                                    </div>
                                </div>
                                <div class="col-md-1 d-none" id="divLoyCou">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Amount </span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_lamount" name="rec_lamount" oninput="validate(this,0)">
                                    </div>
                                </div>
                                <div class="col-md-1 d-none" id="divBD">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Bad Debit</span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_debit" name="rec_debit" oninput="validate(this,0)">
                                    </div>
                                </div>
                                <div class="col-md-1" id="divTabby">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Tabby </span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_tabby" name="rec_tabby" oninput="validate(this,0)">
                                    </div>
                                </div>
                                <div class="col-md-1 d-none" id="divSoft">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Selfologi </span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_self" name="rec_self" oninput="validate(this,0)">
                                    </div>
                                </div>
                                <div class="col-md-1 d-none" id="divSpo">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Spotii </span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_spoti" name="rec_spoti" oninput="validate(this,0)">
                                    </div>
                                </div>
                                <div class="col-md-1 d-none" id="divCob">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Cobone </span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_cob" name="rec_cob" oninput="validate(this,0)">
                                    </div>
                                </div>
                                <div class="col-md-1 d-none" id="divGro">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Groupon </span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_group" name="rec_group" oninput="validate(this,0)">
                                    </div>
                                </div>
                                <div class="col-md-1 d-none" id="divStripe">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Stripe </span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_stripe" name="rec_stripe" oninput="validate(this,0)">
                                    </div>
                                </div>

                                <div class="col-md-1" id="divTamara">
                                    <div class="form-group">
                                        <label class="form-label"><span class="text-info">Tamara </span></label>
                                        <input class="form-control text-end font-weight-semibold" placeholder="" type="text" value="0.00" id="rec_tamara" name="rec_tamara" oninput="validate(this,0)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<div class="row">
    <div class="col-12 col-sm-12 col-md-12 d-flex justify-content-center">
        <div class="form-group">
            <label class="form-label mt-1">&nbsp;<span class="text-danger" id="error_receipts"></span></label>
        </div>
    </div>
</div>
<div class="modal-body p-4">
    <div id="div_billing_list">
        <div class="table-responsive" id="cashtreat">
            <table id="tbl_PackServices" class="table table-striped table-bordered text-nowrap resize-table" style="width: 100%; cursor: pointer;">
                <thead>
                    <tr style="color: #fff !important; background-color: #3C457D; border-color: #3C457D; ">
                        <th class="border-bottom-0 font-weight-semibold text-white text-center"></th>
                        <th class="border-bottom-0 font-weight-semibold text-white">#</th>
                        <th class="border-bottom-0 font-weight-semibold text-white">ID</th>
                        <th class="border-bottom-0 font-weight-semibold text-white">Treatment<br /> ID</th>
                        <th class="border-bottom-0 font-weight-semibold text-white">CPT<br /> Code</th>
                        <th class="border-bottom-0 font-weight-semibold text-white">Treatment Name</th>
                        <th class="border-bottom-0 font-weight-semibold text-white">Total<br /> Sessions</th>
                        <th class="border-bottom-0 font-weight-semibold text-white">Used<br /> Sessions</th>
                        <th class="border-bottom-0 font-weight-semibold text-white">Balance<br /> Sessions</th>
                        <th class="border-bottom-0 font-weight-semibold text-white">Qty</th>
                        <th class="border-bottom-0 font-weight-semibold text-white">Gross</th>
                        <th class="border-bottom-0 font-weight-semibold text-white">Unit<br /> Price</th>
                        <th class="border-bottom-0 font-weight-semibold text-white">Status</th>

                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<script>
   // var totalPrice = 0;
    var isAdded = true;
    var totalPrice = {};

    var isInvoiced = false;
    //#region Page Load
    $(function () {
        $("#rec_advance").select2({
            placeholder: 'Select Advance',
            width: '100%',
            dropdownParent: $('#form_quick_cash_pack')
        });
        $('#rec_chq_date').bootstrapdatepicker({
            format: "dd-MM-yyyy",
            viewMode: "date",
            todayHighlight: true,
            autoclose: true,
            multidate: false,
            multidateSeparator: "-"
        });

        $("#rec_chq_date").bootstrapdatepicker("setDate", 'today');

        $("#rec_bt_bank").select2({
            placeholder: 'Select Bank',
            width: '100%',
            dropdownParent: $('#form_quick_cash_pack')
        });

        $("#rec_advance").select2({
            placeholder: 'Select Advance',
            width: '100%',
            dropdownParent: $('#form_quick_cash_pack')
        });

        $("#rec_voucher").select2({
            placeholder: 'Select Voucher',
            width: '100%',
            dropdownParent: $('#form_quick_cash_pack')
        });

        $("#rec_loyalty").select2({
            placeholder: 'Select Loyality',
            width: '100%',
            dropdownParent: $('#form_quick_cash_pack')
        });
        load_advances();
        GetPatientPackageServices();
        });
    //#endregion

    //#region Load CashTreatments
        var GetPatientPackageServices = function () {
            $.ajax({
                type: "GET",
                url: "@Url.Action("GetPatientPackageServices", "PatientTreatments", new { area = "EMR" })?poId=" + "@Model.PackageOrder.poId" + "&appId=" + "@Model.PackageOrder.appId" + "&patId=" + "@Model.PackageOrder.patId"+"&pt_type=Cash",
                success: function (response) {
                    if (response.isAuthorized != false) {
                        var table;
                        if ($.fn.dataTable.isDataTable('#tbl_PackServices')) {
                            table = $('#tbl_PackServices').DataTable();
                            table.clear();
                            table.rows.add(response).draw();
                        }
                        else {
                            BindDataTablePackages(response);
                        }
                    }
                    else {
                        console.log("You are not Authorized!");
                    }
                },
                error: function (xhr) {
                    console.log(xhr);
                }
            }).done(function () {
                    resizedt();;
                });
        }
    //#endregion

    //#region Bind Datatable
        var BindDataTablePackages = function (response) {

            var table = $("#tbl_PackServices").DataTable({
                fixedHeader: {
                    header: true,
                    footer: true
                },
                processing: true,
                "deferRender": true,
                "pageLength": 100,
                "retrieve": true,
                lengthChange: true,
                "aaData": response,
                "aoColumns": [
                    {
                        "mData": "posId",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row, meta) {
                            // Render checkboxes only if pos_balqty is not zero
                            if (row.pos_balqty !== 0) {
                                if (row.pos_status !== "Invoiced") {
                                    return '<input type="checkbox" class="select-checkbox" />';

                                }
                                else {
                                    return '';
                                }
                            }
                            else {
                                return '';
                            }
                        }

                    },
                    {
                        "mData": "posId",
                        "orderable": false,
                        "searchable": false,
                        "className": "text-center",
                        "render": function (data, type, row, meta) {
                            let _index = (meta.row) + 1;
                            if (_index >= 10) {
                                return "<a href='javascript:void(0)' class='fs-13 font-weight-bold'>" + _index + "</a>";
                            }
                            else {
                                return "<a href='javascript:void(0)' class='fs-13 font-weight-bold'>0" + _index + "</a>";
                            }
                        }
                    },

                    {
                        "mData": "posId",
                        "className": 'text-left',

                    },
                    {
                        "mData": "pos_services",
                        "className": 'text-left',

                    },
                    {
                        "mData": "pos_ps_services_code",
                        "className": 'text-left',

                    },

                    {
                        "mData": "pos_ps_services_name",
                        "className": 'text-wrap text-justify',

                    },
                    {
                        "mData": "pos_qty",
                        "className": 'text-left',

                    },
                    {
                        "mData": "pos_usedqty",
                        "className": 'text-left',

                    },
                    {
                        "mData": "pos_balqty",
                        "className": 'text-left',

                    },
                    {
                        "mData": "pos_sess",
                        "className": 'text-left',
                        "render": function (data, type, row, meta) {
                            var defaultValue = data ? data : 1;
                            return '<input type="number" class="form-control" value="' + defaultValue + '" />';
                        }
                    },
                    {
                        "mData": "pos_ps_disPrice",
                        "render": $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        "mData": "pos_ps_unitPrice",
                        "className": 'text-right',
                        "render": $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        "mData": "pos_status",
                        "className": 'text-left',
                        "createdRow": function (row, data, dataIndex) {
                            console.log("Checking row for pos_status:", data.pos_status);
                            if (data.pos_status === 'invoiced') {
                                console.log("Disabling checkbox for row:", row);
                                $(row).find('input[type="checkbox"]').prop('disabled', true);
                            }
                        }
                    }
                ],
                language: {
                    searchPlaceholder: 'Search...',
                    sSearch: '<span class="text-primary font-weight-semi-bold">Search By Treatment</span>',
                    lengthMenu: '_MENU_',
                    scrollX: "100%",
                },
                searching: false,
                select: {
                    style: 'multi',
                    selector: 'td:first-child'
                },
                scrollX: true,
                scrollY: 500,
                scrollCollapse: true,
                buttons: [
                    {
                        extend: 'excel',
                        title: 'Cash Treatments',
                        footer: 'true',
                        exportOptions: {
                            columns: [0, 1, 2, 3]
                        }
                    },
                    {
                        extend: 'pdf',
                        title: 'Cash Treatments',
                        footer: 'true',
                        exportOptions: {
                            columns: [0, 1, 2, 3]
                        }
                    },
                    {
                        extend: 'csv',
                        title: 'Cash Treatments',
                        footer: 'true',
                        exportOptions: {
                            columns: [0, 1, 2, 3]
                        }
                    },
                    {
                        extend: 'print',
                        title: 'Cash Treatments',
                        footer: 'true',
                        exportOptions: {
                            columns: [0, 1, 2, 3]
                        }
                    },
                    {
                        text: '<i class="fe fe-check-circle"></i> Generate Invoice',
                        className: 'btn-success ms-2',
                        action: function (e, dt, node, config) {
                            GenerateInvoice()
                            }
                    },
                    {
                        text: '<i class="fe fe-check-circle"></i> Add Session',
                        className: 'btn-success ms-2',
                        action: function (e, dt, node, config) {
                            AddSessions()
                        }
                    },
                ]
            });
            table.buttons().container().appendTo('#tbl_PackServices_wrapper .col-md-6:eq(0)');
        };
    //#endregion

    //#region GenerateInvoice
        function GenerateInvoice() {

            var table = $("#tbl_PackServices").DataTable();
            var rows = $(table.$('input[type="checkbox"]').map(function () {
                return $(this).prop("checked") ? $(this).closest('tr') : null;
            }));
            if (rows.length > 0) {
                var dataInsertArray = []; // Array to store _dataInsert objects

                $.each(rows, function (index, rowId) {
                    var _data = table.row(rowId).data();
                    var _dataInsert = {
                        "appId": @Model.PackageOrder.appId,
                        "patId": @Model.PackageOrder.patId,
                        "poId": @Model.PackageOrder.poId,
                        "posId": _data.posId,
                        "pos_services": _data.pos_services,
                        "pos_ps_unitPrice": _data.pos_ps_unitPrice,
                        "pos_status": _data.pos_status,
                        "pos_sess": $(rowId).find('input[type="number"]').val() // Get value from input field

                    };
                    dataInsertArray.push(_dataInsert); // Push _dataInsert into the array
                });

                var _invoice_receipt = {
                "recId": 0,
                "rec_code": '@Model.qc_info.qc_invoice_info.rec_no',
                "rec_date": '@Model.qc_info.qc_invoice_info.inv_date',
                "rec_patient": @Model.qc_info.qc_invoice_info.patId,
                "rec_invoice": 0,
                "rec_cash": parseFloat($("#rec_cash").val()),
                "rec_cc": parseFloat($("#rec_cc").val()),
                "rec_cc_per": parseFloat($("#rec_cc_per").val()),
                "rec_chq": parseFloat($("#rec_chq").val()),
                "rec_chq_no": $("#rec_chq_no").val(),
                "rec_chq_date": $("#rec_chq_date").val(),
                "rec_chq_bank": $("#rec_chq_bank").val(),
                "rec_bt": parseFloat($("#rec_bt").val()),
                "rec_bt_bank": $("#rec_bt_bank").val(),
                "rec_advance": parseInt($("#rec_advance").val()),
                "rec_allocated": parseFloat($("#rec_allocated").val()),
                "rec_notes": $("#rec_notes").val(),
                "rec_madeby": 0,
                "rec_debit": parseFloat($("#rec_debit").val()),
                "rec_branch": "@Model.qc_info.qc_invoice_info.branch",
                "rec_voucher": parseInt($("#rec_voucher").val()),
                "rec_vamount": parseFloat($("#rec_vamount").val()),
                "rec_loyalty": parseInt($("#rec_loyalty").val()),
                "rec_lamount": parseFloat($("#rec_lamount").val()),
                "rec_loy_value": parseFloat($("#rec_loy_value").val()),
                "rec_tabby": parseFloat($("#rec_tabby").val()),
                "rec_self": parseFloat($("#rec_self").val()),
                "rec_spoti": parseFloat($("#rec_spoti").val()),
                "rec_group": parseFloat($("#rec_group").val()),
                "rec_cob": parseFloat($("#rec_cob").val()),
                "rec_stripe": parseFloat($("#rec_stripe").val()),
                "rec_tamara": parseFloat($("#rec_tamara").val())
            }
                var _invoice = {
                    treat_items: dataInsertArray,
                    invoice_receipt: _invoice_receipt
                }
                var _cash = $("#rec_cash").val();
                var _cc = $("#rec_cc").val();
                var _cc_per = $("#rec_cc_per").val();
                var _chq = $("#rec_chq").val();
                var _bt = $("#rec_bt").val();
                var _allocated = $("#rec_allocated").val();
                var _vamount = 0;
                var _lamount = $("#rec_lamount").val();
                var _debit = $("#rec_debit").val();
                var _tabby = $("#rec_tabby").val();
                var _self = $("#rec_self").val();
                var _spoti = $("#rec_spoti").val();
                var _cobone = $("#rec_cob").val();
                var _group = $("#rec_group").val();
                var _stripe = $("#rec_stripe").val();
                var _tamara = $("#rec_tamara").val();

                var rec_total = parseFloat(_cash) + parseFloat(_cc) + parseFloat(_chq) + parseFloat(_bt) + parseFloat(_allocated) + parseFloat(_lamount) +
                    parseFloat(_debit) + parseFloat(_tabby) + parseFloat(_self) + parseFloat(_spoti) + parseFloat(_cobone) + parseFloat(_group) + parseFloat(_stripe) + parseFloat(_tamara);

                console.log(rec_total);

                if (parseFloat(rec_total)>0) {
                    if (dataInsertArray.length > 0) {
                        $.ajax({
                            type: "POST",
                            url: "@Url.Action("GenerateTreatmentsandInvoice", "PatientTreatments", new { area = "EMR" })",
                            dataType: 'JSON',
                            data: _invoice, // Send the array as JSON string
                            success: function (data) {

                                var alertPlaceholder = document.getElementById("billingAlert");
                                function alert(e, t) {
                                    var l = document.createElement("div");
                                    l.innerHTML = '<div class="alert alert-' + t + ' alert-dismissible" role="alert">' + e +
                                        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-hidden="Close">x</button></div>', alertPlaceholder.append(l)
                                }
                                alert("<i class='fe fe-check-circle text-white'></i> Session Inserted and Invoice generated successfully!", "success");
                                clearReceipts();
                                $("#patient_packages_body").modal("hide");

                                // Close the modal
                                $(".close-modal").click(); // Trigger click event on close button
                                Timeout();
                                GetPackageOrders();
                            },
                            error: function (xhr) {
                                // Handle error response
                            }
                        });
                    }
                } else {
                    // Show warning to enter amount
                    ("#error_receipts").html("Please enter at least one amount");
                }
            } else {
                // Handle case where no rows are selected
            }
        }
    //#endregion

    //#region Calc Receipt amout
        $('#tbl_PackServices').on('change', '.select-checkbox', function () {
            let row = $(this).closest('tr');
            let posId = row.find('.text-center').text();
            let pos_sess = parseFloat(row.find('.form-control').val());
            let pos_ps_unitPrice = parseFloat(row.find('.text-right').text().replace(/[^0-9.-]+/g, ''));
            let price = pos_sess * pos_ps_unitPrice;

            // Update total price for this row based on checkbox state
            if (this.checked) {
                totalPrice[posId] = price;
            } else {
                delete totalPrice[posId];
            }

            // Calculate total price of all selected rows
            let total = Object.values(totalPrice).reduce((acc, curr) => acc + curr, 0);
            console.log(total.toFixed(2));
            // Update the total price display
            $('#total_price_display').text(total.toFixed(2));
        });
    //#endregion

    //#region Adv Against Package
        $('#rec_advance').on('select2:select', function (e) {
            calculation_receipts();
        });
    //#endregion

    //#region Receipts
        var calculation_receipts = function () {
            var error = 0;

            var _cash = $("#rec_cash").val();
            var _cc = $("#rec_cc").val();
            var _cc_per = $("#rec_cc_per").val();
            var _chq = $("#rec_chq").val();
            var _bt = $("#rec_bt").val();
            var _allocated = $("#rec_allocated").val();
            var _vamount = 0;
            var _lamount = $("#rec_lamount").val();
            var _debit = $("#rec_debit").val();
            var _tabby = $("#rec_tabby").val();
            var _self = $("#rec_self").val();
            var _spoti = $("#rec_spoti").val();
            var _cobone = $("#rec_cob").val();
            var _group = $("#rec_group").val();
            var _stripe = $("#rec_stripe").val();
            var _tamara = $("#rec_tamara").val();


            //Advance Allocated
            if (($("#rec_advance").val() != null) && ($("#rec_advance").val() != undefined) && ($("#rec_advance").val() != "") && ($("#rec_advance").val() != NaN)) {
                var selected_text = $("#rec_advance option:selected").text();
                var value_arr = selected_text.split("|");
                var amount = value_arr[2].trim().replace(" ", "");

                if (!(parseFloat(amount) >= parseFloat(_allocated))) {
                    error++;
                    $("#error_receipts").html("Allocated Amount Should be less than or equal to " + amount);
                    $("#rec_advance").attr("style", "border:1px solid red;color:red;");
                    $("#rec_allocated").attr("style", "border:1px solid red;color:red;");
                }
                else {
                    $("#error_receipts").html("");
                    $("#rec_advance").attr("style", "border:1px solid #ecebf1;color:#728096;");
                    $("#rec_allocated").attr("style", "border:1px solid #ecebf1;color:#728096;");
                }
            }


            //Cheque
            if (parseFloat(_chq) > 0) {
                if (!(($("#rec_chq_no").val() != null) && ($("#rec_chq_no").val() != undefined) && ($("#rec_chq_no").val() != "") && ($("#rec_chq_no").val() != NaN))) {
                    error++;
                    $("#error_receipts").html("Cheque No is Required ");
                    $("#rec_chq_no").attr("style", "border:1px solid red;color:red;");
                }
                else {
                    $("#error_receipts").html("");
                    $("#rec_chq_no").attr("style", "border:1px solid #ecebf1;color:#728096;");
                }

                if (!(($("#rec_chq_date").val() != null) && ($("#rec_chq_date").val() != undefined) && ($("#rec_chq_date").val() != "") && ($("#rec_chq_date").val() != NaN))) {
                    error++;
                    $("#error_receipts").html("Cheque Date is Required ");
                    $("#rec_chq_date").attr("style", "border:1px solid red;color:red;");
                }
                else {
                    $("#error_receipts").html("");
                    $("#rec_chq_date").attr("style", "border:1px solid #ecebf1;color:#728096;");
                }

                if (!(($("#rec_chq_bank").val() != null) && ($("#rec_chq_bank").val() != undefined) && ($("#rec_chq_bank").val() != "") && ($("#rec_chq_bank").val() != NaN))) {
                    error++;
                    $("#error_receipts").html("Bank Name is Required ");
                    $("#rec_chq_bank").attr("style", "border:1px solid red;color:red;");
                }
                else {
                    $("#error_receipts").html("");
                    $("#rec_chq_bank").attr("style", "border:1px solid #ecebf1;color:#728096;");
                }
            }

            //Bank Transfer
            if (parseFloat(_bt) > 0) {
                if (($("#rec_bt_bank").val() != null) && ($("#rec_bt_bank").val() != undefined) && ($("#rec_bt_bank").val() != "") && ($("#rec_bt_bank").val() != NaN)) {
                    $("#error_receipts").html("");
                    $("#rec_bt_bank").attr("style", "border:1px solid #ecebf1;color:#728096;");

                    var selected_text = $("#rec_bt_bank option:selected").text();
                    var value_arr = selected_text.split("|");
                    var amount = value_arr[2].trim().replace(" ", "");

                    if (!(parseFloat(amount) >= parseFloat(_bt))) {
                        error++;
                        $("#error_receipts").html("Bank Transferred Should be less than or equal to " + amount);
                        $("#rec_bt").attr("style", "border:1px solid red;color:red;");
                        $("#rec_bt_bank").attr("style", "border:1px solid red;color:red;");
                    }
                    else {
                        $("#error_receipts").html("");
                        $("#rec_bt").attr("style", "border:1px solid #ecebf1;color:#728096;");
                        $("#rec_bt_bank").attr("style", "border:1px solid #ecebf1;color:#728096;");
                    }
                }
                else {
                    error++;
                    $("#error_receipts").html("Bank Account is Required for Bank Transfers");
                    $("#rec_bt_bank").attr("style", "border:1px solid red;color:red;");
                }
            }

            if (error == 0) {
                var rec_total = parseFloat(_cash) + parseFloat(_cc) + parseFloat(_chq) + parseFloat(_bt) + parseFloat(_allocated) + parseFloat(_lamount) +
                    parseFloat(_debit) + parseFloat(_tabby) + parseFloat(_self) + parseFloat(_spoti) + parseFloat(_cobone) + parseFloat(_group) + parseFloat(_stripe) + parseFloat(_tamara);

                var table = $('#dtTable_invAddTreatments').DataTable();
                var invTotal = parseFloat($("#total_price_display").text().toFixed(2));


                if (parseFloat(invTotal) >= parseFloat(rec_total)) {

                    if (parseFloat(_vamount) > 0) {
                        rec_total = rec_total + parseFloat(_vamount);

                        if (parseFloat(invTotal) >= parseFloat(rec_total)) {
                            $("#error_receipts").html("");
                        }
                        else {
                            var selected_text = $("#rec_voucher option:selected").text();
                            var value_arr = selected_text.split("|");
                            var amount = value_arr[2].trim().replace(" ", "");
                            var balance = parseFloat(rec_total) - parseFloat(invTotal);
                            $("#error_receipts").html("<span class='text-info mt-1'><i class='fa fa-info-circle'></i><span class='ms-2'>" + balance + " AED of your voucher amount not redeemable</span></span>");
                            rec_total = invTotal;
                        }
                    }
                    else {
                        $("#error_receipts").html("");
                    }

                    $("#btnConfirmBilling").show();
                    $("#btnConfirmBilling_Package").show();

                    isReceipt = true;

                }
                else {
                    $("#error_receipts").html("Receipt total is not more than invoice total");
                    $("#btnConfirmBilling").hide();
                    $("#btnConfirmBilling_Package").hide();
                }
            }
        }
    //#endregion

    //#region load advances
        var load_advances = function () {
             $.ajax({
                 url: '@Url.Action("ReceiptAdvanceByPatId", "Receipt", new { area = "Invoice" })?patId=' + @Model.PackageOrder.patId,
                 type: "GET",
                 dataType: "JSON",
                 async: false,
                 success: function (response) {
                     $('#rec_advance').empty();
                     var _data = response;
                     if (_data.length > 0) {
                         $.each(response, function (j) {
                             var label = response[j]["rec_code"] + " | " + response[j]["rec_date"] + "| [" + response[j]["rec_amount"] + "] | " + response[j]["rec_advance"];
                             var newOption = new Option(label, response[j]["recId"],  false, false);
                             $('#rec_advance').append(newOption).trigger('change');
                         });

                         $('#rec_advance').val(0).trigger('change');
                     }
                 },
                 error: function (xhr) {
                     console.log("Failed! Error Message : " + xhr.statusText);
                 }
             })
        }
    //#endregion

    //#region focusin
        $("#rec_cash").focusin(function () {
            localStorage.setItem("temp_cash", $(this).val());
        });

        $("#rec_cash").focusout(function () {
        var val = parseFloat($(this).val());
        if (val >= 0) {
            localStorage.removeItem("temp_cash");
            calculation_receipts();
        }
        else {
            $(this).val(localStorage.getItem("temp_cash"));
            localStorage.removeItem("temp_cash");
        }
    });
    //#endregion

    //#region Timeout
        function Timeout() {
            window.setTimeout(function () {
                $(".alert").fadeTo(500, 0).slideUp(500, function () {
                    $(this).remove();
                });
            }, 4200);
        }
    //#endregion

    //#region Add Sessions
        function AddSessions() {
        var table = $("#tbl_PackServices").DataTable();
        var rows = $(table.$('input[type="checkbox"]').map(function () {
            return $(this).prop("checked") ? $(this).closest('tr') : null;
        }));
        if (rows.length > 0) {
            var dataInsertArray = []; // Array to store _dataInsert objects

            $.each(rows, function (index, rowId) {
                var _data = table.row(rowId).data();
                var _dataInsert = {
                    "appId": @Model.PackageOrder.appId,
                    "patId": @Model.PackageOrder.patId,
                    "poId": @Model.PackageOrder.poId,
                    "posId": _data.posId,
                    "pos_services": _data.pos_services,
                    "pos_status": _data.pos_status,
                    "pos_ps_unitPrice": _data.pos_ps_unitPrice,
                    "pos_sess": $(rowId).find('input[type="number"]').val() // Get value from input field

                };
                dataInsertArray.push(_dataInsert); // Push _dataInsert into the array
            });

            var _invoice = {
                treat_items: dataInsertArray
            }
            if (dataInsertArray.length > 0) {
                $.ajax({
                    type: "POST",
                    url: "@Url.Action("GenerateTreatments", "PatientTreatments", new { area = "EMR" })",
                    dataType: 'JSON',
                    data: _invoice, // Send the array as JSON string
                    success: function (data) {

                        var alertPlaceholder = document.getElementById("billingAlert");
                        function alert(e, t) {
                            var l = document.createElement("div");
                            l.innerHTML = '<div class="alert alert-' + t + ' alert-dismissible" role="alert">' + e +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-hidden="Close">x</button></div>', alertPlaceholder.append(l)
                        }
                        alert("<i class='fe fe-check-circle text-white'></i> Session Inserted!", "success");
                        clearReceipts();
                        $("#patient_packages_body").modal("hide");
                        //$("#pkg_order_modal_body").modal("show");
                        // Close the modal
                        //$(".close-modal").click(); // Trigger click event on close button
                        Timeout();
                        GetPackageOrders();
                    },
                    error: function (xhr) {
                        // Handle error response
                    }
                });
            }

        } else {
            // Handle case where no rows are selected
        }
        }
    //#endregion

    //#region clearReceipts
        var clearReceipts = function () {
            $("#rec_cash").val("0.00");
            $("#rec_cc").val("0.00");
            $("#rec_cc_per").val("0.00");
            $("#rec_chq").val("0.00");
            $("#rec_chq_no").val("");
            $("#rec_chq_bank").val("");
            $("#rec_chq_date").bootstrapdatepicker("setDate", 'today');
            $("#rec_bt").val("0.00");
            $("#rec_bt_bank").val("");
            $("#rec_advance").empty();
            $("#rec_allocated").val("0.00");
            $("#rec_voucher").empty();
            $("#rec_loyalty").empty();
            $("#rec_lamount").val("0.00");
            $("#rec_debit").val("0.00");
            $("#rec_tabby").val("0.00");
            $("#rec_self").val("0.00");
            $("#rec_spoti").val("0.00");
            $("#rec_cob").val("0.00");
            $("#rec_group").val("0.00");
            $("#rec_stripe").val("0.00");
            $("#rec_tamara").val("0.00");
            $("#rec_notes").val("");
        }
    //#endregion

    //#region Validate
        var validate = function (e, max) {
            var t = e.value;
            var j = (t.indexOf(".") >= 0) ? (t.substr(0, t.indexOf(".")) + t.substr(t.indexOf("."), 3)) : t;
            e.value = (max == 0) ? j : ((j >= max) ? max : j);
        }
    //#endregion

    function Timeout() {
        window.setTimeout(function () {
            $(".alert").fadeTo(500, 0).slideUp(500, function () {
                $(this).remove();
            });
        }, 4200);
    }


    $(".close-modal").on('click', function (e) {
        e.preventDefault();

        $('#patient_packages_body').modal('hide');
    });

</script>