@using System.Linq;
@using System.Security.Claims;
@using BusinessEntities;
@model BusinessEntities.ConsentForms.LaserHairArbDerma

@{
    var claims = ClaimsPrincipal.Current.Identities.First().Claims.ToList();
    var emp_designation = claims.Where(c => c.Type == ClaimTypes.Role).Select(c => c.Value).SingleOrDefault();
    EMRInfo emr = (EMRInfo)TempData["emr_data"];
    TempData.Keep("emr_data");
}
<form id="form_LaserHairArbDermaEdit" autocomplete="off" name="LaserHairArbDerma" ondrop="return false;" onpaste="return false;" oncut="return false;">
    @Html.AntiForgeryToken()
    <div class="row">
        <div class="col-sm-12 col-md-12 col-lg-12 text-right" dir="rtl">
            <div class="border">
                <div class="col-sm-12 col-md-12 col-lg-12">
                    <div class="row mt-2">
                        <div class="col-sm-12 col-md-6 col-lg-2 mb-2">
                            <div class="form-group mb-3"><label class="form-label text-black text-align-left"> اسم المريض</label></div>
                        </div>
                        <div class="col-sm-12 col-md-6 col-lg-4">
                            <label class="form-label text-red text-left text-capitalize">@emr.pat_name</label>
                        </div>
                        <div class="col-sm-12 col-md-6 col-lg-2 mb-2">
                            <div class="form-group mb-3"><label class="form-label text-black"> الهوية الإماراتية</label></div>
                        </div>
                        <div class="col-sm-12 col-md-6 col-lg-4">
                            <label class="form-label text-red text-left">@emr.pat_emirateid</label>
                        </div>
                        <div class="col-sm-12 col-md-3 col-lg-2 mb-2">
                            <div class="form-group mb-3 text-align-left"><label class="form-label text-black ">رقم الملف</label></div>
                        </div>
                        <div class="col-sm-12 col-md-4 col-lg-2">
                            <label class="form-label text-red text-left">@emr.pat_code</label>
                        </div>
                        <div class="col-sm-12 col-md-2 col-lg-2">
                            <div class="form-group mb-3"><label class="form-label text-black"> تاريخ الميلاد</label></div>
                        </div>
                        <div class="col-sm-12 col-md-3 col-lg-2">
                            <label class="form-label text-red text-left">@emr.pat_dob</label>
                        </div>
                        <div class="col-sm-12 col-md-3 col-lg-2 mb-2">
                            <div class="form-group mb-3"><label class="form-label text-black"> الجنسية</label></div>
                        </div>
                        <div class="col-sm-12 col-md-4 col-lg-2">
                            <label class="form-label text-red text-left">@emr.pat_nationality</label>
                        </div>
                        <div class="col-sm-12 col-md-2 col-lg-2">
                            <div class="form-group mb-3"><label class="form-label text-black">جنس</label></div>
                        </div>
                        <div class="col-sm-12 col-md-3 col-lg-2">
                            <label class="form-label text-red text-left">@emr.pat_gender</label>
                        </div>
                        <div class="col-sm-12 col-md-3 col-lg-2">
                            <div class="form-group mb-3"><label class="form-label text-black">اسم الطبيب</label></div>
                        </div>
                        <div class="col-sm-12 col-md-4 col-lg-2">
                            <label class="form-label text-red text-left">@emr.doc_name</label>
                        </div>
                        <div class="col-sm-12 col-md-2 col-lg-2">
                            <div class="form-group mb-3"><label class="form-label text-black">تاريخ</label></div>
                        </div>
                        <div class="col-sm-12 col-md-3 col-lg-2">
                            <label class="form-label text-red text-left">@emr.app_fdate</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5 mt-5 text-justify">
        <div dir="rtl">
            <p>آنا، بموجب هذه المواقة اسمح للطبيب أو أى اخصاني متدرب بالقيام بعلاج الليزر لي،</p>
            <p>
                يقوم جهاز الليزر باستهداف التصبغات فى بصيلة الشعر لمعالجة الشعر الغير مرغوب فيه لاطول فترة ممكنة . ينمو الشع
                بالتدريج ، يعمل الليزر خلال فترة نمو الشعر لذلك عدة جلسات خلال فترات نظامية متباعدة قد تكون مطلوبة لمعالجة كل
                الشعر الموجود فى المنطقة المعالجة . للحصول على اقصى النتانج من الضروري متابعة جدول الجلسات الموصى به .
            </p>
            <p>القد قرأت ووافقت عليه و أدركت النقاط التالية:</p>
            <p>
                -لاينصح بالعلاج بالليزر في حال وجود اى من الحالات التالية: الحمل او الأرضاع.حساسية الضوء،امراض مناعية،داء
                السكري، نزيف غير نظامي، ازمة بسبب الضوء،مرض جلدي، او اى مرض معدي.لقد قمت بابلاغ الأخصاني المعالج في
                حال تواجد احد الحالات المذكورة
            </p>
            <p>
                -لا ينصح بالليزر للمرضى الخاضعين للسمرة من الشمس حتى تزول السمرة و التعرض لاشعة الشمس ممنوع خلال
                العلاج.
            </p>
            <p>
                سوف لن اتعض لأشعة الشمس خلال فترة العلاج كاملة و قبل و بعد ستة اسابيع من الجلسة . ب
                ملتجات التسمبير الصناعية قبل اسبوعين من العلاج.
                سيتم قبل البدء بالعلاج اختبار ردة فعل الجلد،
            </p>
            <p>
                ممكن اخذ بعض الصور لجدولي البيانى و للمقارنة ، و
                احتمالات النجاح : عدة جلسات مطلوبة ، اسابيع او اشهر.خمسة جلسات تكون مثالية، ولكن بعض الاشخاص بحاجة
                التخلص من الشعر يكون ابديا بعد عدة جلسات ، و لكن ليس فى جميع الحالات . قذ ‎E‏
                ‏فى المستقبل. نتيجة العلاج مع كل شخص على حسب لون البشرة، نوع البشرة،و
                ممكن فى الاماكن المعالجة، انا ادرك ايضا ان بعض الاشخاص لايستجيبون للعلاج.
            </p>
            <p>
                -انا ادرك ان عدم القدوم على الموعد أو تأجيله يؤثر فى النتيجة مما يؤدى الى نمو الشعر مجددا و خصوصا فى حالات
                الشعر الناعم او الرقيق.
            </p>
            <p>
                تعليمات قبل/بعد العلاج. نسخة مطبوعة من هذه التعليمات قد اعطت لي و قد ادركتها بشكل كامل. و اتحمل المسنولية
                بالإلتزام بتعليمات السلامة المذكورة سابقا،
            </p>
            <p>التوقف عن استخدام</p>
            <p>
                -لقد تمت مناقشة تكاليف العلاج معى مسبقا
            </p>
            <p>انا على دراية بالمخاطر/المضاعفات المحتمل حصولها مع العلاج بالليذد،</p>
            <p>
                الشعور: يحدث شعور خفيف جدا خلال جلسة العلاج. يتم استخدام جهاز مبرد يرسل رذاذ الى سطح الجلد مع كل اشعاع
                ليزر . الكريم المخدر متوفر للاراحة من هذه الوخزات فى حال الضرورة.
            </p>
            <p>
                التأثيرات الجانبية ممكن حدوثها مثل احمرارءتورم،دخروق خقيفة تزول خلال 1-3 أيام.
                تقشير ممكن حدوثه فى حالات نادرة و يحتاج 3-1 اسابيع للشفاء.
            </p>
            <p>
                العدوى: عدوى الجلد ممكن حدوثها عند تطبيق العلاج و لكن نادرا، داء القوباء(احد انواع الامراض الجلدية) يمكن
                الاصابة به حول الخم بعد الجلسة. هذا ينطبق على مع او مع عدم وجود تاريخ مع هذا الداء.المضادات الحيوية مطلوبة فى
                هذه الحالات و متوفرة مع وصفة طبية . فى حال حدوث عدوى جلدية يجب اخذ علاجات اضافية اومضادات حيوية.
            </p>
            <p>
                التغيرات فى التصبغات : ظهور بعض البقع الداكنة او الفاتحة بعد الجلسات. هذه الحالات نادرة و تشفى خلال اسابيع او
                اشهر معدودة. عدم التعرض لاشعة الشمس خلال و بعد فترة العلاج يقلل من احتمال تغير لون الجلا،
            </p>
            <p>
                جروح او خدوش: ممكن حدوث جروح او تغيرات فى تركيبة الجلد . من الضرورى اتباع تعليمات السلامة للعلاج بعد
                الليزر. الالتزام الجدي يساعد فى منع حدوث مثل هذه الجروح بسبب خارجي بعد الجلسة.
            </p>
            <p>
                حماية العيون: سيكون عليك وضع قناع واقي للعيون. يجب وضع هذا القناع طول فترة الجلسة حتى تقي عيونك من
                اشعاعات الليزد
            </p>
            <p>
                انا اصرح بأني قرأت و ادركت تماما وثيقة الموافقة و قد تم تزويدي بمعلومات كافية و تم الجواب على جميع استفساراتي.
                لقد وافقت على الشروط فى هذه الاتفاقية.
            </p>

        </div>
    </div>
    <div class="row mt-2" dir="rtl">
        <div class="col-sm-12 col-md-12 col-lg-12 text-center table-responsive">
            <table class="table table-bordered table-condensed">
                <tr>
                    <td colspan="3" class="font-weight-bold text-danger fs-18" width="100%">
                        قم بالتوقيع هنا، فقط إذا تمت الإجابة على جميع أسئلتك بما يرضيك
                    </td>
                </tr>
                <tr>
                    <td width="50%">
                        <div id="upat_sign_box" class="d-none">
                            <img alt="stamp" id="upat_sign" class="avatar avatar-xl bsquare" />
                        </div>
                    </td>
                    <td width="50%">
                        <img alt="stamp" src="@emr.doc_sign" id="doc_sign" class="avatar avatar-xl bsquare" />
                    </td>
                </tr>
                <tr>
                    <td width="50%">
                        <label class="form-label text-red text-left text-capitalize">@emr.pat_name&nbsp;</label>
                        <span class="font-weight-semibold">اسم المريض</span>
                        <br /><br />
                        <label class="form-label text-red text-left" id="upsb_date_patient"></label>
                        <span class="font-weight-semibold">تاريخ</span>
                    </td>
                    <td width="50%">
                        <label class="form-label text-red text-left text-capitalize">@emr.doc_name&nbsp;</label>
                        <span class="font-weight-semibold">اسم الطبيب</span>
                        <br /><br />
                        <label class="form-label text-red text-left" id="ulha_date_doctor">@Model.lha_date_modified&nbsp;</label>
                        <span class="font-weight-semibold">تاريخ</span>
                    </td>
                </tr>
                <tr>
                    <td class="font-weight-semibold text-blue" width="50%">
                        Patient Signature<br />توقيع المريض
                        <br />
                        <div class="btn-group mr-2">
                            <div class="dropdown">
                                <button type="button" class="btn-sm btn-secondary me-2 mb-2 dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fa fa-paint-brush">&nbsp;&nbsp;</i> Patient
                                </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" onclick="openSignaturePad('patient')">Tab</a>
                                    <a class="dropdown-item" onclick="openWacomTabSignaturePad('patient')">Wacom Tab</a>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="font-weight-semibold text-blue text-center" width="50%">Doctor’s Signature<br />توقيع الطبيب</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-sm-12 col-md-12 col-lg-12 text-center">
            <div class="btn-list btn-animation">
                <button type="submit" class="btn btn-warning btn-sm" id="btn_Update">Save Changes</button>
                <button type="button" class="btn btn-outline-dark btn-sm" id="btn_Reset">Reset</button>
                <button type="button" class="btn btn-danger btn-sm" id="btn_DeleteForm">Delete</button>
                <button type="button" class="btn btn-sm btn-outline-success" id="btn_Print"> Download/Print </button>
            </div>
        </div>
    </div>
</form>

<script type="text/javascript">

    $(function () {
        if ("@emp_designation.ToString()" === "Super Administrator") {
            $("#btn_Update").show();
        }
        else {
            if ("@emr.set_emr_lock" == "NoLock") {
                $("#btn_Update").show();
            }
            else {
                if ("@emr.app_ae_date" >= "@emr.today") {
                    $("#btn_Update").show();
                }
                else {
                    $("#btn_Update").hide();
                }
            }
        }

        GetSignaturename('patient');

    });

  //#region Update  Click
    $('#btn_Update').on('click', function (e) {
        e.preventDefault();
        if ($("#form_LaserHairArbDermaEdit").valid()) {
            console.log($("#lhaId").val());
        $('#btn_Update').removeClass("btn btn-sm btn-success");
        $('#btn_Update').addClass("btn btn-sm btn-success btn-loaders btn-icon");
        $('#btn_Update').html("Updating the Record....");


            var _dateInsert = {
                "lhaId": 0,
                "lha_appId": @emr.appId,

                "__RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
            }
            console.log(_dateInsert);

            $.ajax({
                type: "Post",
                url: "@Url.Action("EditLaserHairArbDerma", "LaserHairArbDerma", new {area = "ConsentForms" })",
                dataType: 'JSON',
                data: _dateInsert,
                success: function (data) {
                    $('#btn_Update').removeClass("btn btn-sm btn-success btn-loaders btn-icon");
                    $('#btn_Update').addClass("btn btn-sm btn-success");
                    $('#btn_Update').html("Save Changes");



                    if (data.isSuccess) {
                        if (data.isEdited) {
                            GetLaserHairArbDermaInfo();
                            var alertPlaceholder = document.getElementById("Alert");

                            function alert(e, t) {
                                var l = document.createElement("div");
                                l.innerHTML = '<div class="alert alert-' + t + ' alert-dismissible" role="alert">' + e +
                                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-hidden="Close">x</button></div>', alertPlaceholder.append(l)
                            }
                            alert("<i class='fe fe-check-circle text-white'></i>Prp Consent Derma Form Updated Successfully!", "success");

                            Timeout();
                            $("#LaserHairArbDerma_edit").show();
                            $("#LaserHairArbDerma_add").hide();

                        }
                        else {
                            let html = "<div class='col-12 col-sm-12 col-md-6 d-flex justify-content-center'>" +
                                "<div class='alert alert-warning' role='alert'>" +
                                "<button type='button' class='btn-close mr-negative-16' data-bs-dismiss='alert' aria-hidden='true' aria-label='Close'>×</button>" +
                                "<strong>Warning.. LaserHairArb Derma already Exists..</strong><br/>" +
                                "</div></div>";
                            $("#Alert1").html(html);
                        }
                    }
                    else {
                        let html = "<div class='col-12 col-sm-12 col-md-6 d-flex justify-content-center'>" +
                        "<div class='alert alert-danger' role='alert'>" +
                        "<button type='button' class='btn-close mr-negative-16' data-bs-dismiss='alert' aria-hidden='true' aria-label='Close'>×</button>" +
                        "<strong>Validation Error.. Please correct before you submit the form!&nbsp;</strong><br/><ul>";

                        $.each(data.message, function (index, value) {
                            html += "<li><small>" + value + "</small><li>";
                            var elem = $("#" + index);
                            if (elem.hasClass("select2-hidden-accessible")) {
                                $("#select2-" + elem.attr("id") + "-container").parent().addClass('error');
                            }
                            else {
                                $(elem).addClass(" is-invalid");
                            }

                            setTimeout(function () {
                                if (elem.hasClass("select2-hidden-accessible")) {
                                    $("#select2-" + elem.attr("id") + "-container").parent().removeClass('error');
                                }
                                else {
                                    $(elem).removeClass("is-invalid");
                                }
                                }, 5000);
                        });

                        html += "</ul></div></div>";

                        $("#error").html(html);
                    }
                },
                error: function (xhr) {
                    $('#btn_Update').removeClass("btn btn-sm btn-success btn-loaders btn-icon");
                    $('#btn_Update').addClass("btn btn-sm btn-warning");
                    $('#btn_Update').html("Save Changes");
                    Timeout();
                }
            });
        }
        else {
            $('.modal-body').animate({
                scrollTop: ($('.has-error').offset().top - 300)
            }, 2000);
        }

    });
    //#endregion Update Click

            //#region Delete Click
    $('#btn_DeleteForm').on('click', function (e) {
        e.preventDefault();
        $('#btn_DeleteForm').removeClass("btn btn-success");
        $('#btn_DeleteForm').addClass("btn btn-success btn-loaders btn-icon");
        $('#btn_DeleteForm').html("Deleting the Record....");

        $.ajax({
            url: '@Url.Action("DeleteLaserHairArbDerma", "LaserHairArbDerma", new { area = "ConsentForms" })?appId=' + @emr.appId,
            type: "POST",
            dataType: 'JSON',
            success: function (data) {
                $('#btn_DeleteForm').removeClass("btn btn-success btn-loaders btn-icon");
                $('#btn_DeleteForm').addClass("btn btn-warning");
                $('#btn_DeleteForm').html("Delete");

                if (data.isAuthorized) {
                    if (data.success) {
                        var alertPlaceholder = document.getElementById("Alert");
                        function alert(e, t) {
                            var l = document.createElement("div");
                            l.innerHTML = '<div class="alert alert-' + t + ' alert-dismissible" >' + e +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-hidden="Close">x</button></div>', alertPlaceholder.append(l)
                        }
                        alert("<i class='fe fe-check-circle text-white'></i>LaserHairArb Derma Deleted Successfully!", "success");
                        clearControls();

                        $("#LaserHairArbDerma_edit").hide();
                        $("#LaserHairArbDerma_add").show();
                        AddLaserHairArbDerma();
                    }
                    else {
                        let html = "<div class='col-12 col-sm-12 col-md-12 d-flex justify-content-center'>" +
                            "<div class='alert alert-warning' role='alert'>" +
                            "<button type='button' class='btn-close mr-negative-16' data-bs-dismiss='alert' aria-hidden='true' aria-label='Close'>×</button>" +
                            "<strong>Error!.. Failed to Delete..</strong><br/>" +
                            "</div></div>";
                        $("#error").html(html);
                    }
                }
                else {
                    var alertPlaceholder = document.getElementById("Alert");
                    function alert(e, t) {
                        var l = document.createElement("div");
                        l.innerHTML = '<div class="alert alert-' + t + ' alert-dismissible" >' + e +
                            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-hidden="Close">x</button></div>', alertPlaceholder.append(l)
                    }
                    alert("<i class='fe fe-check-circle text-white'></i> You do not have Enough Privileges to Delete this Designation!", "Access Denied!");
                }
            },
            error: function (xhr) {
                $('#btn_DeleteForm').removeClass("btn btn-success btn-loaders btn-icon");
                $('#btn_DeleteForm').addClass("btn btn-Delete");
                $('#btn_DeleteForm').html("Delete");
                Timeout();
            }
        })
    });
//#endregion

    //#region Reset
    $('#btn_Reset').on('click', function (e) {
        e.preventDefault();
        clearControls();
    });
    //#endregion Reset

    //#region Clear Controls
    var clearControls = function () {
        $(".form-control").val("");
        $(".form-control-sm").val("");
        $("#upat_sign").attr("src", "");
    }
    //#endregion Clear Controls

        //#region Print
$('#btn_Print').on('click', function (e) {
    e.preventDefault();
    $('#btn_Print').removeClass("btn btn-sm btn-success");
    $('#btn_Print').addClass("btn btn-sm btn-success btn-loaders btn-icon");
    $('#btn_Print').html("Printing the Record....");
    $.ajax({
        type: "Get",
        url: "@Url.Action("PrintPDFConsent", "LaserHairArbDerma", new {area = "ConsentForms" })?appId=" + @emr.appId + "&form=LaserHairArbDerma",
        dataType: 'JSON',
        success: function (data) {
            if (data.isAuthorized) {
                if (data.success) {
                    window.location.href = data.message.pdfPath
                }
            }
        },
        error: function (xhr) {
            console.log(xhr);
        }
    });
});
//#endregion Print


    //#region Wacom Tab Signature
var openWacomTabSignaturePad = function (id) {
         var _data = {
     "patId": @emr.patId,
     "person": id,
     "form": "LaserHairArbDerma",
     "appId": @emr.appId,
     "formname":"LaserHairArb Derma",
     "formlink":"",
     "eSign":""
 }
        $.ajax({
            type: "GET",
            url: "@Url.Action("WacomTabSignaturePad", "WacomTabSignaturePad", new { area = "Common" })",
            contentType: "application/json",
            dataType: "html",
            data: _data,
            success: function (response) {
                $("#signature_pad_body").html(response);
                $("#signature_pad").modal("show");
            },
            error: function (xhr) {
                console.log("Error :" + xhr.statusText);
            }
        });
    }
//#endregion
    //#region Signature
    var openSignaturePad = function (id) {
        var _data = {
            "patId": @emr.patId,
            "person": id,
            "form": "LaserHairArbDerma",
            "appId": @emr.appId,
            "formname":"LaserHairArb Derma",
            "formlink":"",
            "eSign":""
        }
        $.ajax({
            type: "GET",
            url: "@Url.Action("SignaturePad", "SignaturePad", new { area = "Common" })",
            contentType: "application/json",
            dataType: "html",
            data: _data,
            success: function (response) {
                $("#signature_pad_body").html(response);
                $("#signature_pad").modal("show");
            },
            error: function (xhr) {
                console.log("Error :" + xhr.statusText);
            }
        });
    }
    //#endregion Signature

    $('#signature_pad').on('hidden.bs.modal', function () {
        if (localStorage.getItem("sign") != null) {
            GetSignaturename('patient');
           localStorage.removeItem("sign");
        }
    });

          //#region Get Signature
    var GetSignaturename = function  (person) {
        $.ajax({
            url: '@Url.Action("GetSignature", "SignaturePad", new { area = "Common" })?appId=' + @emr.appId + '&person=' + person + '&form=LaserHairArbDerma',
            type: "GET",
            dataType: "json",
            async: false,
            success: function (response) {
                //console.log(response);
                let sign = response[0].psb_sign;
                var date = moment(response[0].psb_date_modified).format("DD-MM-YYYY");

                if (response[0].person == "patient") {
                    $("#upat_sign_box").removeClass("d-none");
                    $("#upsb_date_patient").text(date);
                    $("#upat_sign").attr("src", sign);
                }
            },
            error: function (xhr) {
                console.log(xhr);
                alert(xhr);
            }

        });
    };
    //#endregion Get Signature

    //#region Alert Timeout
    function Timeout() {
        window.setTimeout(function () {
            $(".alert").fadeTo(500, 0).slideUp(500, function () {
                $(this).remove();
            });
        }, 4200);
    }
    //#endregion Alert Timeout
</script>